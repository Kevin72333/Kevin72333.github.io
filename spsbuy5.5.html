<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>特採系統 (Supabase 版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        // 您的 Supabase 設定
        const supabaseUrl = 'https://htamptcakcnlmltwdcog.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0YW1wdGNha2NubG1sdHdkY29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0ODM2MzAsImV4cCI6MjA2OTA1OTYzMH0.Pt94WOX9lX9svYrq02s27Dvm1El1K2DktAxR9o9nhOE';

        // 初始化 Supabase
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // 將服務掛載到 window 物件上，方便全域呼叫
        window.supabase = supabaseClient;
    </script>

    <style>
        .spinner-container { display: flex; justify-content: center; align-items: center; }
        .spinner-dot { width: 1.5rem; height: 1.5rem; background-color: #3b82f6; border-radius: 50%; margin: 0 0.5rem; animation: bounce-delay 1.4s infinite ease-in-out both; }
        .spinner-dot:nth-child(1) { animation-delay: -0.32s; }
        .spinner-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce-delay { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .view { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #notification-container { position: fixed; top: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
        .notification { padding: 1rem; border-radius: 0.5rem; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards; white-space: pre-wrap; }
        .notification.success { background-color: #28a745; }
        .notification.error { background-color: #dc3545; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: scale(0.9); } }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; }
        .sortable:hover { background-color: #f9fafb; cursor: pointer; }
        .sort-icon { opacity: 0.4; display: inline-block; margin-left: 4px; }
        .sortable.active .sort-icon { opacity: 1; color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 font-sans p-0 sm:p-4 md:p-8">

    <div id="notification-container"></div>
    
    <div id="app-header" class="mb-4"></div>

    <div id="app-container">
        <div id="loading-view" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
            <div class="spinner-container">
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
            </div>
            <p class="mt-8 text-gray-600 text-lg">讀取資料中...</p>
        </div>

        <div id="error-view" class="view p-8 text-center"></div>

        <div id="login-view" class="view"></div>
        <div id="dashboard-view" class="view"></div>
        <div id="newRequest-view" class="view"></div>
        <div id="detailView-view" class="view"></div>
        <div id="productManagement-view" class="view"></div>
        <div id="productForm-view" class="view"></div>
        <div id="personalForms-view" class="view"></div>
        <div id="userManagement-view" class="view"></div>
        <div id="userForm-view" class="view"></div>
        <div id="vendorManagement-view" class="view"></div>
        <div id="vendorForm-view" class="view"></div>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-full overflow-y-auto p-6">
            </div>
    </div>

    <script type="module">
        // --- 工具函式 ---
        const getISODateString = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getFormattedDateTime = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\//g, '-');
        };
        
        const showMessage = (message, type = 'success') => {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), type === 'error' ? 8000 : 3000); // 錯誤訊息顯示久一點
        };

        const saveFavoritesToDb = async (userId, favoritesSet) => {
            const favoritesArray = Array.from(favoritesSet);
            const { error } = await supabase
                .from('users')
                .update({ favorite_products: favoritesArray })
                .eq('id', userId);
            
            if (error) {
                console.error("Error updating favorites:", error);
                showMessage('更新我的最愛失敗: ' + error.message, 'error');
            }
        };

        const validateTaxId = (taxId) => {
            if (!/^\d{8}$/.test(taxId)) return false;
            const multipliers = [1, 2, 1, 2, 1, 2, 4, 1];
            let sum = 0;
            for (let i = 0; i < 8; i++) {
                const product = parseInt(taxId[i]) * multipliers[i];
                sum += Math.floor(product / 10) + (product % 10);
            }
            if (sum % 10 === 0) return true;
            if (taxId[6] === '7' && (sum + 1) % 10 === 0) return true;
            return false;
        };

        // --- 全域常數 ---
        const DEMAND_DEPARTMENTS = [
            "本館生福課", "8C清福", "7C清氣", "6C清心", "5C清平", "3C清安", "2C清護", 
            "2D清護", "8D清春", "7D清日", "6D清照", "5D清風", "3D清景", "8E清山", 
            "7E清泉", "6E清水", "8E清清", "3E清涼", "法人館生福課", "7G一館", "7H一館", 
            "7K一館", "6G一館", "6H一館", "6K一館", "5G二館", "5H二館", "5K二館", 
            "3G三館", "3H三館", "3K三館", "2G三館", "2H三館", "2K三館"
        ];

        // --- 應用程式狀態與設定 ---
        let state = {
            view: 'login',
            requests: [],
            products: {}, // 分類後的產品
            allProducts: [], // 所有產品列表
            vendors: [], // 廠商列表
            users: {}, // key 是 user uuid
            categories: [],
            departments: {},
            applicantNotifications: [],
            currentUser: null, // 包含從 users 表來的 profile
            selectedRequest: null,
            editingRequest: null, // *** NEW: 正在編輯的草稿 ***
            editingProduct: null,
            editingUser: null,
            editingVendor: null, 
            loading: true,
            error: null,
            local: {
                dashboardFilters: {
                    vendors: new Set(),
                    statuses: new Set(),
                },
                personalForms: {
                    activeTab: 'inbox', 
                    inbox: { searchTerm: '' },
                    sent: { status: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                    history: { status: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                },
                userManagementFilters: {
                    department: 'all',
                    searchTerm: ''
                },
                vendorManagementSearchTerm: '',
                newRequestCart: [],
                activeProductCategory: '我的最愛',
                activeProductManagementCategory: '全品項',
                selectedRequestIds: new Set(),
                currentPage: 1,
                itemsPerPage: 10,
                permissionFilter: 'my', 
                consolidatedData: null,
                sortKey: 'request_date', 
                sortDirection: 'desc',
                productManagementSearchTerm: '',
                newRequestSearchTerm: '',
                newRequestSearchAll: false,
                productSortKey: 'id',
                productSortDirection: 'asc',
                productFilters: {},
                favoriteProductIds: new Set(),
            }
        };

        // --- Supabase API 呼叫函式 ---
        const { supabase } = window;
        
        let channels = []; // 用來存放 real-time channel
        let tempSelections = {
            vendors: new Set(),
            statuses: new Set()
        };

        const loadDashboardData = async (shouldNavigateToDashboard = false) => {
            updateState({ loading: true });
            channels.forEach(channel => supabase.removeChannel(channel));
            channels = [];

            try {
                const [usersRes, categoriesRes, departmentsRes, productsRes, requestsRes, notificationsRes, vendorsRes] = await Promise.all([
                    supabase.from('users').select('*'),
                    supabase.from('categories').select('name'),
                    supabase.from('departments').select('department, director_threshold'),
                    supabase.from('products').select('*'),
                    supabase.from('requests').select('*').order('request_date', { ascending: false }),
                    supabase.from('notifications').select('*').eq('user_id', state.currentUser.id).order('timestamp', { ascending: false }),
                    supabase.from('vendors').select('*').order('vendor_id', { ascending: true })
                ]);

                const results = [usersRes, categoriesRes, departmentsRes, productsRes, requestsRes, notificationsRes, vendorsRes];
                for (const res of results) {
                    if (res.error) throw res.error;
                }
                
                const usersData = {};
                usersRes.data.forEach(user => {
                    usersData[user.id] = user;
                });

                const categoriesData = categoriesRes.data.map(cat => cat.name);

                const departmentsData = {};
                departmentsRes.data.forEach(dept => {
                    departmentsData[dept.department] = dept.director_threshold;
                });

                const productsData = {};
                const allProducts = productsRes.data;
                allProducts.forEach(product => {
                    const category = product.category;
                    if (!productsData[category]) productsData[category] = [];
                    productsData[category].push(product);
                });

                const requests = requestsRes.data;
                const applicantNotifications = notificationsRes.data;
                const vendors = vendorsRes.data;

                const finalStateUpdate = { 
                    users: usersData, 
                    categories: categoriesData, 
                    departments: departmentsData,
                    products: productsData,
                    allProducts,
                    vendors,
                    requests,
                    applicantNotifications,
                    loading: false
                };

                if (shouldNavigateToDashboard) {
                    finalStateUpdate.view = 'dashboard';
                }

                updateState(finalStateUpdate);
                setupRealtimeListeners();

            } catch (err) {
                console.error("讀取儀表板資料時發生錯誤:", err);
                updateState({ error: err.message, loading: false });
            }
        };
        
        function setupRealtimeListeners() {
            const requestsChannel = supabase.channel('public:requests')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'requests' }, payload => {
                    console.log('Request change received!', payload);
                    handleRealtimeUpdate(payload, 'requests', 'id');
                })
                .subscribe();
            channels.push(requestsChannel);

            const productsChannel = supabase.channel('public:products')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, async (payload) => {
                    console.log('Product change received!', payload);
                    const { data, error } = await supabase.from('products').select('*');
                    if (error) {
                        console.error("Realtime refetching products failed:", error);
                        return;
                    }
                    
                    const allProducts = data;
                    const productsData = {};
                    allProducts.forEach(product => {
                        const category = product.category;
                        if (!productsData[category]) productsData[category] = [];
                        productsData[category].push(product);
                    });
                    
                    updateState({ allProducts, products: productsData });
                })
                .subscribe();
            channels.push(productsChannel);
            
            const notificationsChannel = supabase.channel(`public:notifications:user_id=eq.${state.currentUser.id}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'notifications', filter: `user_id=eq.${state.currentUser.id}`}, payload => {
                    console.log('Notification change received!', payload);
                    handleRealtimeUpdate(payload, 'applicantNotifications', 'id');
                })
                .subscribe();
            channels.push(notificationsChannel);
        }

        function handleRealtimeUpdate(payload, stateKey, idField) {
            const currentItems = [...state[stateKey]];
            switch (payload.eventType) {
                case 'INSERT':
                    currentItems.unshift(payload.new);
                    break;
                case 'UPDATE':
                    const indexToUpdate = currentItems.findIndex(item => item[idField] === payload.new[idField]);
                    if (indexToUpdate > -1) {
                        currentItems[indexToUpdate] = payload.new;
                    } else {
                        currentItems.unshift(payload.new);
                    }
                    break;
                case 'DELETE':
                    const indexToDelete = currentItems.findIndex(item => item[idField] === payload.old[idField]);
                    if (indexToDelete > -1) {
                        currentItems.splice(indexToDelete, 1);
                    }
                    break;
            }
            if (stateKey === 'requests') {
                currentItems.sort((a, b) => new Date(b.request_date) - new Date(a.request_date));
            }
            if (stateKey === 'applicantNotifications') {
                currentItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            updateState({ [stateKey]: currentItems });
        }

        // --- 狀態管理 ---
        const updateState = (newState) => {
            const oldView = state.view;
            
            if (newState.local) {
                newState.local = { ...state.local, ...newState.local };
            }

            Object.assign(state, newState);

            if (newState.view && newState.view !== oldView) {
                state.local.selectedRequestIds.clear();
                state.local.currentPage = 1;
                state.editingRequest = null; // 清除草稿狀態
                render();
            } else {
                window.requestAnimationFrame(render);
            }
        };

        // --- 全域渲染函式 ---
        const render = () => {
            const { view, loading, error, currentUser } = state;
            
            document.getElementById('loading-view').style.display = loading ? 'flex' : 'none';
            
            const errorView = document.getElementById('error-view');
            if (error) {
                errorView.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">發生錯誤！</strong><span class="block sm:inline">${error}</span><div class="mt-4"><button onclick="location.reload()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">重新載入</button></div></div>`;
                errorView.style.display = 'block';
            } else {
                errorView.style.display = 'none';
            }

            const views = ['login-view', 'dashboard-view', 'newRequest-view', 'detailView-view', 'productManagement-view', 'productForm-view', 'personalForms-view', 'userManagement-view', 'userForm-view', 'vendorManagement-view', 'vendorForm-view'];
            views.forEach(v => {
                const el = document.getElementById(v);
                if (el) el.style.display = 'none';
            });

            if (loading || error) return;
            
            renderAppHeader();

            if (!currentUser) {
                renderLoginView();
                return;
            }
            
            const viewFnName = `render${view.charAt(0).toUpperCase() + view.slice(1)}`;
            const renderFn = window[viewFnName];
            
            if (typeof renderFn === 'function') {
                renderFn();
            }
        };
        
        const renderAppHeader = () => {
            const headerEl = document.getElementById('app-header');
            if (!state.currentUser) {
                headerEl.innerHTML = '';
                return;
            }
            headerEl.innerHTML = `
                <div class="bg-white p-2 rounded-md shadow-sm flex items-center justify-end space-x-4 text-sm">
                    <button data-view="personalForms" class="view-switch-btn text-blue-600 hover:underline">個人表單管理</button>
                    <div id="notification-bell-container" class="flex items-center space-x-2 relative"></div>
                    <span class="text-gray-600">歡迎, ${state.currentUser.name} (${state.currentUser.role})</span>
                    <button id="change-password-btn" class="text-blue-600 hover:underline">修改密碼</button>
                    <button id="logout-btn" class="text-red-600 hover:underline">登出</button>
                </div>`;
            renderNotifications();
        };

        const renderNotifications = () => {
            const bellContainer = document.getElementById('notification-bell-container');
            if (!bellContainer) return;

            const pendingForMe = state.requests.filter(req => {
                if (!req.approvers) return false;
                const nextApprover = req.approvers.find(a => a.status === 'pending');
                return req.status === '待審核' && nextApprover && nextApprover.userId === state.currentUser.id;
            });
            
            const myNotifications = state.applicantNotifications.filter(n => n.user_id === state.currentUser.id);
            const unreadMyNotifications = myNotifications.filter(n => !n.is_read);

            const totalUnreadCount = pendingForMe.length + unreadMyNotifications.length;

            let bellHTML = `
                <div id="notification-bell" class="relative cursor-pointer">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    ${totalUnreadCount > 0 ? `<span class="absolute top-0 right-0 -mt-1 -mr-1 flex justify-center items-center h-4 w-4 rounded-full bg-red-500 text-white text-xs pointer-events-none"></span>` : ''}
                </div>
            `;
            
            if (totalUnreadCount > 0) {
                bellHTML += `<span class="text-red-500 font-bold text-xs">${totalUnreadCount}</span>`;
            }

            if (pendingForMe.length > 0 || myNotifications.length > 0) {
                let dropdownHTML = `<div id="notification-dropdown" class="hidden absolute right-0 top-full mt-2 w-80 bg-white rounded-md shadow-lg z-20 border max-h-96 overflow-y-auto"><ul>`;
                
                if (pendingForMe.length > 0) {
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800">待我簽核 (${pendingForMe.length})</li>`;
                    pendingForMe.forEach(req => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full bg-blue-500 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${req.id}" class="min-w-0 flex-grow">
                                    <p class="text-sm text-gray-800 whitespace-normal">${req.id}</p>
                                    <span class="text-xs font-normal text-gray-600">來自 ${state.users[req.applicant_id]?.name || '未知'} の申請</span>
                                </a>
                            </li>`;
                    });
                }

                if (myNotifications.length > 0) {
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800">表單進度更新</li>`;
                    myNotifications.forEach(n => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-start space-x-2">
                                <span class="w-2 h-2 rounded-full ${!n.is_read ? 'bg-blue-500' : 'bg-transparent'} mt-1.5 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${n.request_id}" data-notification-id="${n.id}" class="min-w-0 flex-grow">
                                    <p class="whitespace-normal text-sm text-gray-800">${n.message}</p>
                                    <span class="text-xs text-gray-400">${getFormattedDateTime(n.timestamp)}</span>
                                </a>
                            </li>`;
                    });
                }

                dropdownHTML += `</ul></div>`;
                bellHTML += dropdownHTML;
            }
            bellContainer.innerHTML = bellHTML;
        };


        const renderLoginView = () => {
            const viewEl = document.getElementById('login-view');
            viewEl.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold text-center mb-6">特採系統登入</h2>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="account" class="block text-sm font-medium text-gray-700">帳號 (工號、ID 或 Email)</label>
                                <input type="text" id="account" name="account" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700">密碼</label>
                                <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">登入</button>
                        </form>
                    </div>
                </div>`;
            viewEl.style.display = 'block';
        };

        // --- 視圖渲染器 ---
        window.renderDashboard = () => {
            const viewEl = document.getElementById('dashboard-view');
            const { currentUser } = state;
            const isPurchasing = currentUser.role === '採購' || currentUser.role === '採購主管';
            const isAdmin = currentUser.is_admin;
            const isPendingForMeView = state.local.dashboardFilters.permission === 'pending_for_me';
            const hasSelection = state.local.selectedRequestIds.size > 0;
            
            if (!state.local.dashboardFilters.dateFrom) {
                const now = new Date();
                const firstDay = new Date(2025, 6, 1); // July is month 6
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                state.local.dashboardFilters.dateFrom = getISODateString(firstDay);
                state.local.dashboardFilters.dateTo = getISODateString(lastDay);
            }

            if (!state.local.dashboardFilters.permission) {
                state.local.dashboardFilters.permission = 'pending_for_me';
            }

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex flex-wrap justify-between items-center sticky top-0 z-10 gap-4">
                    <h1 class="text-2xl font-bold text-gray-700">特別採購單</h1>
                    <div class="flex items-center flex-wrap space-x-4">
                        ${isPendingForMeView ? `
                            <button data-action="batch-approve" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" ${!hasSelection ? 'disabled' : ''}>批次核准</button>
                            <button data-action="batch-reject" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed" ${!hasSelection ? 'disabled' : ''}>批次退回</button>
                        ` : ''}
                        ${isPurchasing ? `
                            <button data-action="batch-close" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-500 text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" ${!hasSelection ? 'disabled' : ''}>批次結案</button>
                        ` : ''}
                        <button data-action="refresh" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-500 text-white hover:bg-indigo-600">重新整理</button>
                        <button data-action="consolidate-by-vendor" class="px-4 py-2 rounded-md font-semibold text-sm bg-teal-600 text-white hover:bg-teal-700">依廠商彙整</button>
                        <button data-action="export" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">匯出訂單</button>
                        ${isAdmin ? '<button data-view="userManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">使用者管理</button>' : ''}
                        <button data-view="vendorManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">廠商管理</button>
                        <button data-view="productManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">商品管理</button>
                        <button data-view="newRequest" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            新增申請
                        </button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div id="dashboard-filters" class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6 pb-6 border-b border-gray-200"></div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"></thead>
                            <tbody id="dashboard-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm"></div>
                </div>`;
            
            renderDashboardFilters();
            renderDashboardTable();
            viewEl.style.display = 'block';
        };

        const renderMultiSelect = (filterKey, placeholder, options) => {
            const selectedItems = state.local.dashboardFilters[filterKey] || new Set();
            
            const selectedLabels = options
                .filter(opt => selectedItems.has(opt.value))
                .map(opt => opt.label);

            const displayValue = selectedItems.size > 2 
                ? `${placeholder} (${selectedItems.size} 已選)` 
                : (selectedItems.size > 0 ? selectedLabels.join(', ') : placeholder);

            return `
                <div class="relative multi-select-container">
                    <button data-filter-key="${filterKey}" class="multi-select-toggle w-full p-2 border border-gray-300 rounded-md shadow-sm text-left truncate">${displayValue}</button>
                    <div class="multi-select-dropdown hidden absolute z-10 w-full bg-white border rounded-md shadow-lg mt-1">
                        <input type="text" class="multi-select-search w-full p-2 border-b" placeholder="搜尋...">
                        <ul class="max-h-40 overflow-y-auto">
                            ${options.map(option => `
                                <li>
                                    <label class="flex items-center p-2 hover:bg-gray-100">
                                        <input type="checkbox" class="multi-select-checkbox" data-filter-key="${filterKey}" value="${option.value}">
                                        <span class="ml-2 text-sm">${option.label}</span>
                                    </label>
                                </li>
                            `).join('')}
                        </ul>
                        <div class="p-2 border-t flex justify-between items-center bg-gray-50">
                            <div>
                                <button data-action="select-all-multi" data-filter-key="${filterKey}" class="text-xs text-blue-600 hover:underline">全選</button>
                                <button data-action="deselect-all-multi" data-filter-key="${filterKey}" class="text-xs text-blue-600 hover:underline ml-2">全不選</button>
                            </div>
                            <div>
                                <button data-action="cancel-multi-select" class="px-3 py-1 text-xs rounded-md bg-gray-200 hover:bg-gray-300">取消</button>
                                <button data-action="confirm-multi-select" data-filter-key="${filterKey}" class="px-3 py-1 text-xs rounded-md bg-blue-600 text-white hover:bg-blue-700 ml-2">確定</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        const renderDashboardFilters = () => {
            const container = document.getElementById('dashboard-filters');
            if(!container) return;
            const filters = state.local.dashboardFilters;
            const dateFrom = filters.dateFrom;
            const dateTo = filters.dateTo;

            const { currentUser } = state;
            const isPurchasing = currentUser.role === '採購' || currentUser.role === '採購主管';
            let permissionOptions = `
                <option value="my">我申請的訂單</option>
                <option value="pending_for_me">待我簽核的單據</option>
                <option value="approved_by_me">我簽核過的</option>
                <option value="rejected_by_me">我退回簽核的</option>
            `;
            if (currentUser.is_department_head) {
                permissionOptions += `<option value="department">我的部門訂單</option>`;
            }
            if (isPurchasing) {
                permissionOptions += `<option value="all">所有訂單</option>`;
            }

            const vendorOptions = state.vendors.map(v => ({
                value: v.vendor_id,
                label: `${v.short_name || v.name} (${v.vendor_id})`
            }));
            const allStatuses = ['待審核', '已核准', '已退回'].map(s => ({ value: s, label: s }));

            container.innerHTML = `
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">檢視權限</label>
                    <select data-filter="permission" class="filter-change w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        ${permissionOptions}
                    </select>
                </div>
                <div class="md:col-span-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">日期區間</label>
                    <div class="flex items-center space-x-2">
                        <input type="date" data-filter="dateFrom" value="${dateFrom}" class="filter-change w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                        <span>~</span>
                        <input type="date" data-filter="dateTo" value="${dateTo}" class="filter-change w-full p-2 border border-gray-300 rounded-md shadow-sm" />
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">廠商</label>
                    ${renderMultiSelect('vendors', '選擇廠商', vendorOptions)}
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                     ${renderMultiSelect('statuses', '選擇狀態', allStatuses)}
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">搜尋</label>
                    <div class="flex">
                        <input type="text" id="dashboard-search-input" placeholder="搜尋所有欄位..." class="w-full p-2 border border-gray-300 rounded-l-md shadow-sm" value="${filters.searchTerm || ''}" />
                        <button data-action="search-dashboard" class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">搜尋</button>
                    </div>
                </div>
            `;
            container.querySelector('[data-filter="permission"]').value = filters.permission || 'my';
        };

        const getFilteredRequests = (() => {
            let lastFilters = null;
            let lastResult = [];

            const func = () => {
                const { currentUser, requests } = state;
                const { dashboardFilters, sortKey, sortDirection } = state.local;
                
                const filtersForCache = {
                    ...dashboardFilters,
                    vendors: [...(dashboardFilters.vendors || [])].sort(),
                    statuses: [...(dashboardFilters.statuses || [])].sort(),
                };

                const currentFilters = JSON.stringify({
                    filters: filtersForCache,
                    sortKey,
                    sortDirection,
                    reqCount: requests.length,
                    userId: currentUser.id
                });

                if (currentFilters === lastFilters) {
                    return lastResult;
                }

                let baseRequests;
                const permission = dashboardFilters.permission || 'my';

                switch(permission) {
                    case 'my': baseRequests = requests.filter(req => req.applicant_id === currentUser.id); break;
                    case 'pending_for_me': 
                        baseRequests = requests.filter(req => {
                            if (!req.approvers) return false;
                            const nextApprover = req.approvers.find(a => a.status === 'pending');
                            return req.status === '待審核' && nextApprover && nextApprover.userId === currentUser.id;
                        });
                        break;
                    case 'approved_by_me': baseRequests = requests.filter(req => (req.approvers || []).some(a => a.userId === currentUser.id && a.status === 'approved')); break;
                    case 'rejected_by_me': baseRequests = requests.filter(req => (req.approvers || []).some(a => a.userId === currentUser.id && a.status === 'rejected')); break;
                    case 'department': baseRequests = currentUser.is_department_head ? requests.filter(req => req.department === currentUser.department) : requests.filter(req => req.applicant_id === currentUser.id); break;
                    case 'all': baseRequests = (currentUser.role === '採購' || currentUser.role === '採購主管') ? requests : requests.filter(req => req.applicant_id === currentUser.id); break;
                    default: baseRequests = requests.filter(req => req.applicant_id === currentUser.id);
                }

                const { dateFrom, dateTo, vendors: selectedVendorIds = new Set(), statuses = new Set(), searchTerm = '' } = dashboardFilters;
                const lowerCaseSearchTerm = searchTerm.toLowerCase();

                const selectedVendorNames = new Set();
                if (selectedVendorIds.size > 0) {
                    state.vendors.forEach(vendor => {
                        if (selectedVendorIds.has(vendor.vendor_id)) {
                            selectedVendorNames.add(vendor.name);
                            if (vendor.short_name) {
                                selectedVendorNames.add(vendor.short_name);
                            }
                        }
                    });
                }

                let filtered = baseRequests.filter(req => {
                    const requestDate = req.request_date ? getISODateString(req.request_date) : '';
                    if (dateFrom && dateTo && (requestDate < dateFrom || requestDate > dateTo)) return false;
                    
                    if (selectedVendorIds.size > 0) {
                        const hasMatchingVendor = (req.items || []).some(item => {
                            return selectedVendorIds.has(item.vendor) || selectedVendorNames.has(item.vendor);
                        });
                        if (!hasMatchingVendor) return false;
                    }

                    if (statuses.size > 0 && !statuses.has(req.status)) return false;
                    if (lowerCaseSearchTerm && !JSON.stringify(req).toLowerCase().includes(lowerCaseSearchTerm)) return false;
                    return true;
                });

                if (sortKey) {
                    filtered.sort((a, b) => {
                        let valA = a[sortKey];
                        let valB = b[sortKey];

                        if (sortKey === 'applicant_id') {
                            valA = state.users[valA]?.name || '';
                            valB = state.users[valB]?.name || '';
                        }
                        
                        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                lastFilters = currentFilters;
                lastResult = filtered;
                return filtered;
            };

            func.resetCache = () => {
                lastFilters = null;
            };

            return func;
        })();

        const renderDashboardTable = () => {
            const tableBody = document.getElementById('dashboard-table-body');
            if (!tableBody) return;
            const tableHead = tableBody.previousElementSibling;
            
            const filteredRequests = getFilteredRequests();
            const { currentPage, itemsPerPage } = state.local;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedRequests = filteredRequests.slice(startIndex, endIndex);

            const renderSortIcon = (key) => {
                if (state.local.sortKey !== key) return `<span class="sort-icon">▲▼</span>`;
                return state.local.sortDirection === 'asc' ? `<span class="sort-icon">▲</span>` : `<span class="sort-icon">▼</span>`;
            };

            if(tableHead) {
                tableHead.innerHTML = `
                    <tr>
                        <th class="p-4 relative">
                            <div class="group inline-block">
                                <button class="border px-2 py-1 rounded">選取</button>
                                <div class="absolute hidden group-hover:block bg-white shadow-md rounded-md mt-1 border z-10">
                                    <a href="#" data-action="select-page" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">全選此頁</a>
                                    <a href="#" data-action="select-all-filtered" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">全選所有</a>
                                    <a href="#" data-action="deselect-all" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">取消選取</a>
                                </div>
                            </div>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">功能</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.sortKey === 'id' ? 'active' : ''}" data-action="sort" data-sort-key="id">申請單號 ${renderSortIcon('id')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.sortKey === 'applicant_id' ? 'active' : ''}" data-action="sort" data-sort-key="applicant_id">申請人 ${renderSortIcon('applicant_id')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.sortKey === 'request_date' ? 'active' : ''}" data-action="sort" data-sort-key="request_date">申請日期 ${renderSortIcon('request_date')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.sortKey === 'department' ? 'active' : ''}" data-action="sort" data-sort-key="department">科室 ${renderSortIcon('department')}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.sortKey === 'total_amount' ? 'active' : ''}" data-action="sort" data-sort-key="total_amount">總金額 ${renderSortIcon('total_amount')}</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.sortKey === 'status' ? 'active' : ''}" data-action="sort" data-sort-key="status">狀態 ${renderSortIcon('status')}</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">結案狀態</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">簽核進度</th>
                    </tr>
                `;
            }

            tableBody.innerHTML = paginatedRequests.map(req => {
                const approvers = req.approvers || [];
                const approverStatus = approvers.map(a => `${a.role}: ${a.status === 'approved' ? '✔️' : a.status === 'rejected' ? '❌' : '…'}`).join(' | ');
                const statusStyles = {'待送出': 'bg-gray-100 text-gray-800', '待審核': 'bg-yellow-100 text-yellow-800', '已核准': 'bg-green-100 text-green-800', '已退回': 'bg-red-100 text-red-800'};
                const closedStatusStyles = {'未結案': 'bg-blue-100 text-blue-800', '結案': 'bg-gray-300 text-gray-800'};
                const isChecked = state.local.selectedRequestIds.has(req.id);
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4"><input type="checkbox" class="request-checkbox" data-id="${req.id}" ${isChecked ? 'checked' : ''} /></td>
                        <td class="px-6 py-4"><button data-id="${req.id}" data-action="view-detail" class="text-blue-600 hover:text-blue-900"><svg class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button></td>
                        <td class="px-6 py-4 text-sm text-gray-900">${req.id}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${state.users[req.applicant_id]?.name || '未知'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${getFormattedDateTime(req.request_date)}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${req.department}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 text-right">$${Number(req.total_amount).toLocaleString()}</td>
                        <td class="px-6 py-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-medium ${statusStyles[req.status] || 'bg-gray-100 text-gray-800'}">${req.status}</span></td>
                        <td class="px-6 py-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-medium ${closedStatusStyles[req.closed_status] || ''}">${req.closed_status || '未結案'}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-500">${approverStatus}</td>
                    </tr>`;
            }).join('') || `<tr><td colspan="10" class="text-center py-10 text-gray-500">無符合條件的申請單</td></tr>`;

            renderPaginationControls(filteredRequests.length);
        };

        const renderPaginationControls = (totalItems) => {
            const controlsContainer = document.getElementById('pagination-controls');
            if (!controlsContainer) return;

            const { currentPage, itemsPerPage } = state.local;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (totalPages <= 1) {
                controlsContainer.innerHTML = '';
                return;
            }

            let buttonsHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const isCurrent = i === currentPage;
                buttonsHTML += `<button data-action="go-to-page" data-page="${i}" class="${isCurrent ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'} px-3 py-1 border border-gray-300 rounded-md">${i}</button>`;
            }

            controlsContainer.innerHTML = `
                <div class="text-gray-600">
                    共 ${totalItems} 筆資料，目前在第 ${currentPage} / ${totalPages} 頁
                </div>
                <div class="flex items-center space-x-2">
                    <button data-action="go-to-page" data-page="${currentPage - 1}" class="px-3 py-1 border rounded-md disabled:opacity-50" ${currentPage === 1 ? 'disabled' : ''}>上一頁</button>
                    ${buttonsHTML}
                    <button data-action="go-to-page" data-page="${currentPage + 1}" class="px-3 py-1 border rounded-md disabled:opacity-50" ${currentPage === totalPages ? 'disabled' : ''}>下一頁</button>
                </div>
            `;
        };
        
        window.renderNewRequest = function() {
            const viewEl = document.getElementById('newRequest-view');
            const categories = ['我的最愛', '購買過的', '全品項', ...Object.keys(state.products)];
            const activeCategory = state.local.activeProductCategory || '我的最愛';
            const isEditingDraft = !!state.editingRequest;

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditingDraft ? `編輯草稿: ${state.editingRequest.id}` : '特採物品申請菜單'}</h1>
                    <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="lg:w-2/3">
                        <div class="bg-white shadow-md rounded-lg p-6">
                            <div class="mb-4 border-b border-gray-200">
                                <nav class="product-categories -mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                                    ${categories.map(cat => `<button data-category="${cat}" data-action="switch-category" class="product-category-btn ${cat === activeCategory ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">${cat}</button>`).join('')}
                                </nav>
                            </div>
                            <div class="flex items-center gap-4 mb-4">
                                <input type="text" id="new-request-product-search" placeholder="搜尋商品..." class="w-full p-2 border border-gray-300 rounded-md" value="${state.local.newRequestSearchTerm || ''}">
                                <button data-action="search-new-request-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">搜尋</button>
                                <label class="flex items-center text-sm whitespace-nowrap">
                                    <input type="checkbox" id="new-request-search-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${state.local.newRequestSearchAll ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-700">搜尋全分類</span>
                                </label>
                            </div>
                            <div class="product-list grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                        </div>
                    </div>
                    <div class="lg:w-1/3">
                        <div id="new-request-sidebar" class="bg-white shadow-md rounded-lg p-6 sticky top-24"></div>
                    </div>
                </div>`;
            renderProductList();
            renderNewRequestSidebar();
            viewEl.style.display = 'block';
        };

        const renderProductList = () => {
            const productListEl = document.querySelector('#newRequest-view .product-list');
            if (!productListEl) return;
            
            const { activeProductCategory, newRequestSearchTerm, newRequestSearchAll } = state.local;
            const searchTerm = (newRequestSearchTerm || '').toLowerCase();

            let productsToSearch = [];
            if (newRequestSearchAll) {
                productsToSearch = state.allProducts;
            } else {
                if (activeProductCategory === '我的最愛') {
                    productsToSearch = state.allProducts.filter(p => state.local.favoriteProductIds.has(p.id));
                } else if (activeProductCategory === '購買過的') {
                    const purchasedProductIds = new Set();
                    state.requests
                        .filter(req => req.applicant_id === state.currentUser.id && req.status === '已核准')
                        .forEach(req => {
                            (req.items || []).forEach(item => purchasedProductIds.add(item.id));
                        });
                    productsToSearch = state.allProducts.filter(p => purchasedProductIds.has(p.id));
                } else if (activeProductCategory === '全品項' || !activeProductCategory) {
                    productsToSearch = state.allProducts;
                } else {
                    productsToSearch = state.products[activeProductCategory] || [];
                }
            }

            let displayProducts = productsToSearch;
            if (searchTerm) {
                displayProducts = productsToSearch.filter(p => {
                    const { image, ...searchableProduct } = p; // Exclude image URL from search
                    return Object.values(searchableProduct).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                });
            }

            if (displayProducts.length === 0) {
                productListEl.innerHTML = `<p class="text-gray-500 col-span-full text-center">找不到符合條件的商品</p>`;
                return;
            }
            productListEl.innerHTML = displayProducts.map(p => {
                const imageUrl = p.image 
                    ? `https://drive.google.com/thumbnail?id=${p.image}` 
                    : 'https://placehold.co/150x150?text=無圖片';
                const vendorName = state.vendors.find(v => v.vendor_id === p.vendor)?.short_name || p.vendor || 'N/A';
                return `
                <div class="border rounded-lg p-4 flex flex-col items-center text-center shadow-sm relative">
                    <button data-action="toggle-favorite" data-product-id="${p.id}" class="absolute top-2 right-2 text-gray-300 hover:text-yellow-500">
                        <svg class="w-5 h-5 ${state.local.favoriteProductIds.has(p.id) ? 'text-yellow-400' : ''}" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                        </svg>
                    </button>
                    <img src="${imageUrl}" alt="${p.name}" class="w-24 h-24 object-cover mb-2 rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/150x150?text=圖片錯誤';"/>
                    <h3 class="font-semibold text-sm">${p.name}</h3>
                    <p class="text-xs text-gray-500">${p.spec || ''}</p>
                    <p class="text-xs text-gray-500">廠商: ${vendorName}</p>
                    <p class="text-sm font-bold my-1">$${p.price || 0}/${p.unit}</p>
                    <div class="flex items-center mt-2">
                        <input type="number" min="1" data-id="${p.id}" class="product-quantity-input w-16 text-center border-gray-300 rounded-md shadow-sm" value="1" />
                        <button data-product='${JSON.stringify(p)}' data-action="add-to-cart" class="add-to-cart-btn ml-2 p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">+</button>
                    </div>
                </div>`}).join('');
        };

        const renderNewRequestSidebar = () => {
            const sidebarEl = document.getElementById('new-request-sidebar');
            if (!sidebarEl) return;
            const cart = state.local.newRequestCart;
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const isEditingDraft = !!state.editingRequest;

            const cartItemsHTML = () => {
                if (cart.length === 0) return `<p class="text-gray-500 text-center py-8">購物車是空的</p>`;
                return `<ul class="divide-y divide-gray-200">${cart.map(item => {
                    const reasonOptions = ['新增', '修繕', '報廢', '其他'];
                    return `
                    <li class="py-3">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-500">$${item.price} / ${item.unit}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" min="1" value="${item.quantity}" data-id="${item.id}" data-action="update-cart-quantity" class="w-16 text-center border-gray-300 rounded-md shadow-sm">
                                <button data-id="${item.id}" data-action="remove-from-cart" class="text-red-500 hover:text-red-700 p-1"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                            </div>
                        </div>
                        <div class="mt-2 pl-2 border-l-2 space-y-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700">需求課室</label>
                                <input list="demand-department-list" data-id="${item.id}" data-action="update-item-demand-dept" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm" value="${item.demand_department || ''}" placeholder="搜尋或選擇課室...">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700">申請原因</label>
                                <select data-id="${item.id}" data-action="update-item-reason" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm">
                                    ${reasonOptions.map(opt => `<option value="${opt}" ${item.reason === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700">說明</label>
                                <textarea data-id="${item.id}" data-action="update-item-description" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm" rows="2" placeholder="如：新增設備、某某物品損壞...">${item.description || ''}</textarea>
                            </div>
                            <div>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" data-id="${item.id}" data-action="toggle-item-scrap" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${item.is_scrap_work_order ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-700">報廢工單</span>
                                </label>
                                <div class="mt-1 ${item.is_scrap_work_order ? '' : 'hidden'}">
                                    <label class="block text-xs font-medium text-gray-700">工單號碼</label>
                                    <input type="text" data-id="${item.id}" data-action="update-item-work-order" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm" value="${item.work_order_number || ''}">
                                </div>
                            </div>
                        </div>
                    </li>
                `}).join('')}</ul>`;
            };

            sidebarEl.innerHTML = `
                <h2 class="text-lg font-bold mb-4 border-b pb-2">檢視清單</h2>
                <datalist id="demand-department-list">
                    ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}"></option>`).join('')}
                </datalist>
                <div class="mb-4 p-2 bg-gray-100 rounded-md">
                    <div class="text-sm font-medium text-gray-700">申請人</div>
                    <div class="text-base font-semibold text-gray-900">${state.currentUser.name} (${state.currentUser.department})</div>
                </div>
                <div class="mb-4">
                    <label for="request-reason" class="block text-sm font-medium text-gray-700">總說明 (選填)</label>
                    <textarea id="request-reason" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="可填寫此張申請單的整體目的...">${isEditingDraft ? state.editingRequest.reason || '' : ''}</textarea>
                </div>
                <div class="border-t pt-4 mb-4">
                    <div class="flex justify-between items-center font-bold text-lg">
                        <span>總金額</span>
                        <span class="cart-total">$${totalAmount.toLocaleString()}</span>
                    </div>
                    <div class="flex space-x-2 mt-4">
                        <button data-action="save-request" class="w-full px-4 py-2 rounded-md font-semibold text-sm bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50" ${cart.length === 0 ? 'disabled' : ''}>${isEditingDraft ? '更新草稿' : '儲存草稿'}</button>
                        <button data-action="submit-request" class="w-full px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50" ${cart.length === 0 ? 'disabled' : ''}>送出申請</button>
                    </div>
                </div>
                <div class="cart-items max-h-[calc(100vh-34rem)] overflow-y-auto border-t pt-2">${cartItemsHTML()}</div>
                `;
        };
        
        window.renderDetailView = function() {
            const viewEl = document.getElementById('detailView-view');
            const request = state.selectedRequest;
            if (!request) {
                viewEl.innerHTML = `<p>找不到申請單</p>`;
                viewEl.style.display = 'block';
                return;
            }

            const getApproverStatusUI = (approver) => {
                let statusHTML = '';
                const approverUser = state.users[approver.userId];
                const approverInfo = approverUser ? `(${approverUser.email} ${approverUser.name})` : `(${approver.userId.substring(0,8)})`;

                if (approver.status === 'approved') statusHTML = `<span class="text-green-600">✔️ 已核准 (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>`;
                else if (approver.status === 'rejected') statusHTML = `<span class="text-red-600">❌ 已退回 (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>`;
                else statusHTML = `<span class="text-gray-500">… 待簽核 by ${approver.role} ${approverInfo}</span>`;
                
                if(approver.comment) statusHTML += `<p class="text-xs text-gray-500 pl-4">意見: ${approver.comment}</p>`;
                if(approver.reason) statusHTML += `<p class="text-xs text-red-500 pl-4">退回原因: ${approver.reason}</p>`;
                return statusHTML;
            };
            
            const nextApprover = (request.approvers || []).find(a => a.status === 'pending');
            const canApprove = state.currentUser && nextApprover && state.currentUser.id === nextApprover.userId;
            const isPurchaser = state.currentUser.role.includes('採購');
            const isPurchaserEditing = canApprove && isPurchaser;

            const itemsHTML = (request.items || []).map((item, index) => {
                const subtotal = (item.price || 0) * (item.quantity || 0);
                const workOrderNumber = item.is_scrap_work_order && item.work_order_number ? item.work_order_number : '';
                
                const product = state.allProducts.find(p => p.id === item.id);
                const imageUrl = product?.image 
                    ? `https://drive.google.com/thumbnail?id=${product.image}` 
                    : 'https://placehold.co/64x64?text=無圖片';
                const vendorName = state.vendors.find(v => v.vendor_id === item.vendor)?.short_name || item.vendor || '';

                if (isPurchaserEditing) {
                    return `
                        <tr class="border-b item-row">
                            <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=錯誤';"/></td>
                            <td class="px-4 py-2 align-top">
                                <input name="name_${index}" class="w-full p-1 border rounded" value="${item.name || ''}">
                                <div class="text-xs text-gray-500 mt-1">
                                    <p><b>原因:</b> ${item.reason || 'N/A'}</p>
                                    <p><b>說明:</b> ${item.description || 'N/A'}</p>
                                </div>
                            </td>
                            <td class="px-4 py-2 align-top">${item.demand_department || ''}</td>
                            <td class="px-4 py-2 align-top"><input name="vendor_${index}" class="w-full p-1 border rounded" value="${item.vendor || ''}"></td>
                            <td class="px-4 py-2 text-right align-top"><input name="price_${index}" type="number" data-index="${index}" class="item-input w-24 p-1 border rounded text-right" value="${item.price || 0}"></td>
                            <td class="px-4 py-2 text-right align-top">
                                <input name="quantity_${index}" type="number" data-index="${index}" class="item-input w-16 p-1 border rounded text-right" value="${item.quantity || 0}">
                                <input name="unit_${index}" class="w-12 p-1 border rounded text-right" value="${item.unit || ''}">
                            </td>
                            <td class="px-4 py-2 text-right align-top subtotal-cell" data-index="${index}">$${subtotal.toLocaleString()}</td>
                            <td class="px-4 py-2 text-center align-top">${item.is_scrap_work_order ? '✔️' : ''}</td>
                            <td class="px-4 py-2 align-top">${workOrderNumber}</td>
                        </tr>`;
                }
                return `
                    <tr class="border-b">
                        <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=錯誤';"/></td>
                        <td class="px-4 py-2 align-top">
                            ${item.name}
                            <div class="text-xs text-gray-500 mt-1">
                                <p><b>原因:</b> ${item.reason || 'N/A'}</p>
                                <p><b>說明:</b> ${item.description || 'N/A'}</p>
                            </div>
                        </td>
                        <td class="px-4 py-2 align-top">${item.demand_department || ''}</td>
                        <td class="px-4 py-2 align-top">${vendorName}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.price || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">${item.quantity} ${item.unit}</td>
                        <td class="px-4 py-2 text-right align-top">$${subtotal.toLocaleString()}</td>
                        <td class="px-4 py-2 text-center align-top">${item.is_scrap_work_order ? '✔️' : ''}</td>
                        <td class="px-4 py-2 align-top">${workOrderNumber}</td>
                    </tr>`;
            }).join('');
            
            const modificationHistoryHTML = (request.modification_history || []).map(entry => `
                <div class="text-xs text-gray-500 border-t pt-2 mt-2">
                    <p><strong>修改人:</strong> ${entry.user} (${entry.role}) 於 ${getFormattedDateTime(entry.date)}</p>
                    <p><strong>修改原因:</strong> ${entry.reason}</p>
                </div>
            `).join('');

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">申請單詳情: ${request.id}</h1>
                    <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div><span class="font-bold text-gray-600">申請單號:</span> ${request.id}</div>
                        <div><span class="font-bold text-gray-600">申請日期:</span> ${getFormattedDateTime(request.request_date)}</div>
                        <div><span class="font-bold text-gray-600">狀態:</span> <span class="px-3 py-1 rounded-full text-xs font-medium ${{'待審核': 'bg-yellow-100 text-yellow-800', '已核准': 'bg-green-100 text-green-800', '已退回': 'bg-red-100 text-red-800'}[request.status] || 'bg-gray-100 text-gray-800'}">${request.status}</span></div>
                        <div><span class="font-bold text-gray-600">申請人:</span> ${state.users[request.applicant_id]?.name || '未知'}</div>
                        <div><span class="font-bold text-gray-600">申請部門:</span> ${request.department}</div>
                        <div><span class="font-bold text-gray-600">結案狀態:</span> <span class="px-3 py-1 rounded-full text-xs font-medium ${request.closed_status === '結案' ? 'bg-gray-300 text-gray-800' : 'bg-blue-100 text-blue-800'}">${request.closed_status || '未結案'}</span></div>
                        <div class="md:col-span-3"><span class="font-bold text-gray-600">總說明:</span> <span class="text-gray-800 whitespace-pre-wrap">${request.reason || '無'}</span></div>
                    </div>
                    <h3 class="text-lg font-bold border-b pb-2 mb-4">申請項目</h3>
                    <form id="edit-request-form">
                        <div class="overflow-x-auto mb-6">
                            <table class="min-w-full">
                                <thead class="bg-gray-100"><tr><th class="px-4 py-2 text-left">圖片</th><th class="px-4 py-2 text-left">品名/說明</th><th class="px-4 py-2 text-left">需求課室</th><th class="px-4 py-2 text-left">廠商</th><th class="px-4 py-2 text-right">單價</th><th class="px-4 py-2 text-right">數量</th><th class="px-4 py-2 text-right">小計</th><th class="px-4 py-2 text-center">報廢</th><th class="px-4 py-2 text-left">工單號碼</th></tr></thead>
                                <tbody>${itemsHTML}</tbody>
                                <tfoot><tr class="font-bold"><td colspan="6" class="px-4 py-2 text-right">總金額:</td><td id="grand-total" class="px-4 py-2 text-right">$${Number(request.total_amount).toLocaleString()}</td><td colspan="2"></td></tr></tfoot>
                            </table>
                        </div>
                    </form>
                    ${modificationHistoryHTML ? `<h3 class="text-lg font-bold border-b pb-2 mb-4">修改歷史</h3><div class="space-y-2 mb-6">${modificationHistoryHTML}</div>` : ''}
                    <h3 class="text-lg font-bold border-b pb-2 mb-4">簽核流程</h3>
                    <div class="space-y-4 mb-6">
                        ${(request.approvers || []).map(approver => {
                            let displayRole = approver.role;
                            if (approver.role === '使用者') {
                                if (approver.step === 1) displayRole = '申請人主管';
                                else if (approver.step === 2) displayRole = '申請人主管的主管';
                            }
                            return `<div class="flex items-start"><div class="font-bold w-48 flex-shrink-0">${displayRole}:</div><div>${getApproverStatusUI(approver)}</div></div>`;
                        }).join('')}
                    </div>
                    <div class="border-t pt-6 flex justify-end space-x-4">
                        ${isPurchaser && request.status === '已核准' ? `
                            <button data-action="close-request" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-700 text-white hover:bg-green-800" ${request.closed_status === '結案' ? 'disabled' : ''}>
                                ${request.closed_status === '結案' ? '已結案' : '將此單結案'}
                            </button>
                        ` : ''}
                        ${ canApprove ? `
                        <div class="flex-grow flex justify-end space-x-4">
                            ${isPurchaserEditing ? `
                            <div class="flex-grow">
                                <label for="modification-reason" class="block text-sm font-medium text-gray-700">修改原因</label>
                                <textarea id="modification-reason" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                            </div>` : ''}
                            <div class="flex-grow">
                                <label for="approval-comment" class="block text-sm font-medium text-gray-700">簽核意見 (選填)</label>
                                <textarea id="approval-comment" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                            </div>
                            <div class="flex items-end space-x-4">
                                ${isPurchaserEditing ? '<button data-action="save-changes" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">儲存修改並核准</button>' : ''}
                                <button data-action="reject" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">退回</button>
                                <button data-action="approve" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">核准</button>
                            </div>
                        </div>` : ''}
                    </div>
                </div>`;
             viewEl.style.display = 'block';
        };
        
        window.renderProductManagement = function() {
            const viewEl = document.getElementById('productManagement-view');
            const categories = ['全品項', ...Object.keys(state.products)];
            const activeCategory = state.local.activeProductManagementCategory || '全品項';
            
            const filteredProducts = getFilteredProducts();

            const renderSortIcon = (key) => {
                if (state.local.productSortKey !== key) return `<span class="sort-icon">▲▼</span>`;
                return state.local.productSortDirection === 'asc' ? `<span class="sort-icon">▲</span>` : `<span class="sort-icon">▼</span>`;
            };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">商品管理</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                        <button data-action="add-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">新增產品</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-4 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                            ${categories.map(cat => `<button data-category="${cat}" data-action="switch-product-category" class="product-category-btn ${cat === activeCategory ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">${cat}</button>`).join('')}
                        </nav>
                    </div>
                     <div class="mb-4 flex items-center gap-4">
                        <input type="text" id="product-search-input" placeholder="搜尋商品..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm" value="${state.local.productManagementSearchTerm || ''}">
                        <button data-action="search-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">搜尋</button>
                        <label class="flex items-center text-sm whitespace-nowrap">
                            <input type="checkbox" id="product-management-search-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${state.local.productManagementSearchAll ? 'checked' : ''}>
                            <span class="ml-2 text-gray-700">搜尋全分類</span>
                        </label>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'id' ? 'active' : ''}" data-action="sort-product" data-sort-key="id">商品編號 ${renderSortIcon('id')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'name' ? 'active' : ''}" data-action="sort-product" data-sort-key="name">品名 ${renderSortIcon('name')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'vendor' ? 'active' : ''}" data-action="sort-product" data-sort-key="vendor">廠商 ${renderSortIcon('vendor')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'spec' ? 'active' : ''}" data-action="sort-product" data-sort-key="spec">規格 ${renderSortIcon('spec')}</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'price' ? 'active' : ''}" data-action="sort-product" data-sort-key="price">單價 ${renderSortIcon('price')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">訂購系統</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">功能</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredProducts.map(p => {
                                    const spec = p.spec || '';
                                    const displaySpec = spec.length > 10 ? spec.substring(0, 10) + '...' : spec;
                                    const vendorName = state.vendors.find(v => v.vendor_id === p.vendor)?.short_name || p.vendor || '';
                                    return `
                                    <tr key="${p.id}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${vendorName}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span title="${spec}">${displaySpec}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">$${Number(p.price || 0).toLocaleString()}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.ordering_system || '特採'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-id="${p.id}" data-action="edit-product" class="text-blue-600 hover:text-blue-900">編輯</button>
                                            <button data-id="${p.id}" data-name="${p.name}" data-action="delete-product" class="text-red-600 hover:text-red-900 ml-4">刪除</button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            viewEl.style.display = 'block';
        };

        window.renderProductForm = function() {
            const viewEl = document.getElementById('productForm-view');
            const product = state.editingProduct;
            const isEditing = !!product;
            const formData = product || { id: '', name: '', category: '', vendor: '', spec: '', price: 0, unit: '', ordering_system: '特採', image: '' };
            const imageUrl = formData.image ? `https://drive.google.com/thumbnail?id=${formData.image}` : 'https://placehold.co/200x200?text=無圖片';
            
            const vendorOptions = state.vendors.map(v => 
                `<option value="${v.vendor_id}" ${formData.vendor === v.vendor_id ? 'selected' : ''}>${v.short_name || v.name} (${v.vendor_id})</option>`
            ).join('');

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? '編輯商品' : '新增商品'}</h1>
                    <button data-view="productManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-4xl mx-auto">
                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 flex flex-col items-center">
                            <img id="product-form-image-preview" src="${imageUrl}" alt="Product Image" class="w-48 h-48 object-cover mb-4 rounded-md border" onerror="this.onerror=null;this.src='https://placehold.co/200x200?text=圖片錯誤';"/>
                            <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                            <label for="image-upload-input" class="cursor-pointer px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">選擇圖片</label>
                            <span id="image-upload-filename" class="text-xs text-gray-500 mt-2">尚未選擇檔案</span>
                            <button type="button" id="image-upload-button" data-action="upload-image" class="mt-2 px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50" disabled>上傳圖片</button>
                            <input type="hidden" name="image" value="${formData.image || ''}">
                        </div>

                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">商品編號</label>
                                <input type="text" name="id" value="${formData.id}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100" ${isEditing ? 'readonly' : 'required'}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">品名</label>
                                <input type="text" name="name" value="${formData.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">分類</label>
                                <input type="text" name="category" value="${formData.category}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">廠商</label>
                                <select name="vendor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 請選擇廠商 --</option>
                                    ${vendorOptions}
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">規格</label>
                                <textarea name="spec" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${formData.spec || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">單價</label>
                                <input type="number" name="price" step="any" value="${formData.price}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">單位</label>
                                <input type="text" name="unit" value="${formData.unit}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">訂購系統</label>
                                <input type="text" name="ordering_system" value="${formData.ordering_system}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                        </div>
                        
                        <div class="md:col-span-3 flex justify-end mt-4">
                            <button type="button" data-action="save-product" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">儲存</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderPersonalForms = function() {
            const viewEl = document.getElementById('personalForms-view');
            const { activeTab } = state.local.personalForms;
            
            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">個人專區</h1>
                    <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回主儀表板</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button data-tab="inbox" class="tab-button ${activeTab === 'inbox' ? 'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">收件資料夾</button>
                            <button data-tab="sent" class="tab-button ${activeTab === 'sent' ? 'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">原稿資料夾</button>
                            <button data-tab="history" class="tab-button ${activeTab === 'history' ?'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">逐級通知資料夾</button>
                        </nav>
                    </div>
                    <div id="personal-forms-content" class="mt-6">
                    </div>
                </div>`;
            
            renderPersonalFormsContent();
            viewEl.style.display = 'block';
        };
        
        const renderPersonalFormsContent = () => {
            const contentEl = document.getElementById('personal-forms-content');
            if (!contentEl) return;

            const { activeTab } = state.local.personalForms;
            const filters = state.local.personalForms[activeTab];
            const { currentUser, requests, applicantNotifications } = state;
            
            let items = [];
            let isRequestList = true;

            if (activeTab === 'inbox') {
                isRequestList = false;
                items = [...applicantNotifications].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                 if (filters.searchTerm) {
                    const lowerSearchTerm = filters.searchTerm.toLowerCase();
                    items = items.filter(n => JSON.stringify(n).toLowerCase().includes(lowerSearchTerm));
                }
            } else {
                let baseRequests = [];
                if (activeTab === 'sent') {
                    baseRequests = requests.filter(req => req.applicant_id === currentUser.id);
                } else if (activeTab === 'history') {
                    baseRequests = requests.filter(req => (req.approvers || []).some(a => a.userId === currentUser.id && (a.status === 'approved' || a.status === 'rejected')));
                }

                items = baseRequests.filter(req => {
                    if (filters.status !== 'all' && req.status !== filters.status) return false;
                    if (filters.searchTerm && !JSON.stringify(req).toLowerCase().includes(filters.searchTerm.toLowerCase())) return false;
                    
                    if (activeTab === 'sent' || activeTab === 'history') {
                        const requestDate = getISODateString(req.request_date);
                        if (filters.dateFrom && requestDate < filters.dateFrom) return false;
                        if (filters.dateTo && requestDate > filters.dateTo) return false;
                    }
                    return true;
                });
            }

            const itemsHTML = items.length > 0 ? items.map(item => {
                if (isRequestList) {
                    const req = item;
                    return `
                        <li class="border p-4 rounded-lg hover:bg-gray-50">
                            <a href="#" data-action="view-detail" data-id="${req.id}" class="block">
                                <div class="flex justify-between items-center">
                                    <p class="font-bold text-blue-600">${req.id}</p>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${{'待送出': 'bg-gray-100 text-gray-800', '待審核': 'bg-yellow-100 text-yellow-800', '已核准': 'bg-green-100 text-green-800', '已退回': 'bg-red-100 text-red-800'}[req.status] || 'bg-gray-100 text-gray-800'}">${req.status}</span>
                                </div>
                                <p class="text-sm text-gray-600 mt-2">申請日期: ${getFormattedDateTime(req.request_date)}</p>
                                <p class="text-sm text-gray-600">總金額: $${Number(req.total_amount).toLocaleString()}</p>
                                <p class="text-sm text-gray-500 mt-1 truncate">原因: ${req.reason || '無'}</p>
                            </a>
                        </li>`;
                } else {
                    const n = item;
                    return `
                        <li class="p-4 rounded-lg ${n.is_read ? 'bg-gray-50' : 'bg-blue-50'}">
                            <a href="#" data-action="view-notification-detail" data-id="${n.request_id}" data-notification-id="${n.id}" class="block">
                                <div class="flex justify-between items-center">
                                    <p class="text-sm text-gray-800 ${!n.is_read ? 'font-bold' : ''}">${n.message}</p>
                                    <span class="text-xs text-gray-500 whitespace-nowrap">${getFormattedDateTime(n.timestamp)}</span>
                                </div>
                            </a>
                        </li>`;
                }
            }).join('') : `<p class="text-center text-gray-500 py-8">此資料夾中沒有任何項目。</p>`;

            let dateFilterHTML = '';
            if (activeTab === 'sent' || activeTab === 'history') {
                const dateFrom = filters.dateFrom || '';
                const dateTo = filters.dateTo || '';
                dateFilterHTML = `
                    <div class="flex items-center space-x-2">
                        <input type="date" data-filter-type="dateFrom" value="${dateFrom}" class="personal-forms-filter p-2 border border-gray-300 rounded-md shadow-sm" />
                        <span>~</span>
                        <input type="date" data-filter-type="dateTo" value="${dateTo}" class="personal-forms-filter p-2 border border-gray-300 rounded-md shadow-sm" />
                    </div>
                `;
            }

            contentEl.innerHTML = `
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    ${dateFilterHTML}
                    ${activeTab !== 'inbox' ? `
                    <select data-filter-type="status" class="personal-forms-filter p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="all" ${filters.status === 'all' ? 'selected' : ''}>所有狀態</option>
                        <option value="待送出" ${filters.status === '待送出' ? 'selected' : ''}>待送出</option>
                        <option value="待審核" ${filters.status === '待審核' ? 'selected' : ''}>待審核</option>
                        <option value="已核准" ${filters.status === '已核准' ? 'selected' : ''}>已核准</option>
                        <option value="已退回" ${filters.status === '已退回' ? 'selected' : ''}>已退回</option>
                    </select>` : ''}
                    <input type="text" data-filter-type="searchTerm" placeholder="搜尋..." class="personal-forms-filter flex-grow p-2 border border-gray-300 rounded-md shadow-sm" value="${filters.searchTerm || ''}">
                </div>
                <ul class="space-y-4">${itemsHTML}</ul>
            `;
        };

        window.renderUserManagement = function() {
            const viewEl = document.getElementById('userManagement-view');
            const { department, searchTerm } = state.local.userManagementFilters;
            const allDepartments = ['all', ...Object.keys(state.departments)];

            const filteredUsers = Object.values(state.users).filter(user => {
                if (department !== 'all' && user.department !== department) return false;
                if (searchTerm && !JSON.stringify(user).toLowerCase().includes(searchTerm.toLowerCase())) return false;
                return true;
            });

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">使用者管理</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                        <button data-action="add-user" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">新增使用者</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select id="user-dept-filter" class="p-2 border border-gray-300 rounded-md shadow-sm">
                            ${allDepartments.map(d => `<option value="${d}" ${department === d ? 'selected' : ''}>${d === 'all' ? '所有部門' : d}</option>`).join('')}
                        </select>
                        <input type="text" id="user-search-input" placeholder="搜尋姓名、Email、工號..." class="md:col-span-2 p-2 border border-gray-300 rounded-md shadow-sm" value="${searchTerm}">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">姓名</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">部門</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">角色</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">狀態</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">功能</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredUsers.map(user => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.department || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.role} ${user.is_admin ?'(管理員)' : ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center">
                                            <button data-action="toggle-user-enabled" data-id="${user.id}" data-enabled="${user.is_enabled}" class="px-3 py-1 rounded-full text-xs font-medium ${user.is_enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${user.is_enabled ? '啟用' : '停用'}
                                            </button>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-id="${user.id}" data-action="edit-user" class="text-blue-600 hover:text-blue-900">編輯</button>
                                            <button data-id="${user.id}" data-name="${user.name}" data-action="delete-user" class="text-red-600 hover:text-red-900 ml-4">刪除</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderUserForm = function() {
            const viewEl = document.getElementById('userForm-view');
            const user = state.editingUser;
            const formData = user || { email: '', name: '', employee_id: '', role: '使用者', department: '', is_admin: false, is_department_head: false, is_enabled: true, manager_id: null, manager_id2: null };
            const isEditing = !!user;
            
            const allUsers = Object.values(state.users);
            const allDepartments = Object.keys(state.departments);
            const allRoles = ['使用者', '採購', '採購主管', '院長'];

            const userOptions = allUsers
                .filter(u => !isEditing || u.id !== user.id)
                .map(u => `<option value="${u.id}" ${ (isEditing && (u.id === formData.manager_id || u.id === formData.manager_id2)) ? 'selected' : '' }>${u.name} (${u.email})</option>`).join('');

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? '編輯使用者' : '新增使用者'}</h1>
                    <button data-view="userManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-2xl mx-auto">
                    <form id="user-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" name="email" value="${formData.email}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">姓名</label>
                                <input type="text" name="name" value="${formData.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">工號</label>
                                <input type="text" name="employee_id" value="${formData.employee_id || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                            </div>
                            ${!isEditing ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-700">密碼</label>
                                <input type="password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required placeholder="至少6位數" />
                            </div>` : ''}
                            <div>
                                <label class="block text-sm font-medium text-gray-700">角色</label>
                                <select name="role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    ${allRoles.map(r => `<option value="${r}" ${formData.role === r ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">部門</label>
                                <select name="department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 請選擇 --</option>
                                    ${allDepartments.map(d => `<option value="${d}" ${formData.department === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">直屬主管</label>
                                <select name="manager_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 無 --</option>
                                    ${allUsers.map(u => `<option value="${u.id}" ${formData.manager_id === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">第二主管</label>
                                <select name="manager_id2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 無 --</option>
                                    ${allUsers.map(u => `<option value="${u.id}" ${formData.manager_id2 === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_admin" name="is_admin" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_admin ? 'checked' : ''} />
                                <label for="is_admin" class="ml-2 block text-sm text-gray-900">設為系統管理員</label>
                            </div>
                             <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_department_head" name="is_department_head" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_department_head ? 'checked' : ''} />
                                <label for="is_department_head" class="ml-2 block text-sm text-gray-900">設為部門主管</label>
                            </div>
                            <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_enabled" name="is_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_enabled ? 'checked' : ''} />
                                <label for="is_enabled" class="ml-2 block text-sm text-gray-900">啟用此帳號</label>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="button" data-action="save-user" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">儲存</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderVendorManagement = function() {
            const viewEl = document.getElementById('vendorManagement-view');
            const searchTerm = state.local.vendorManagementSearchTerm.toLowerCase();
            const filteredVendors = state.vendors.filter(v => 
                JSON.stringify(v).toLowerCase().includes(searchTerm)
            );

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">廠商管理</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                        <button data-action="add-vendor" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">新增廠商</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-4">
                        <input type="text" id="vendor-search-input" placeholder="搜尋廠商..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm" value="${state.local.vendorManagementSearchTerm}">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">廠商代號</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">廠商簡稱</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">聯絡人</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">連絡電話</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">功能</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredVendors.map(v => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.vendor_id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.short_name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.contact_person || ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.phone || ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-id="${v.vendor_id}" data-action="edit-vendor" class="text-blue-600 hover:text-blue-900">編輯</button>
                                            <button data-id="${v.vendor_id}" data-name="${v.name}" data-action="delete-vendor" class="text-red-600 hover:text-red-900 ml-4">刪除</button>
                                        </td>
                                    </tr>
                                `).join('') || `<tr><td colspan="5" class="text-center py-10 text-gray-500">找不到廠商</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderVendorForm = function() {
            const viewEl = document.getElementById('vendorForm-view');
            const vendor = state.editingVendor;
            const isEditing = !!vendor;
            const formData = vendor || { tax_id: '', address: '', invoice_address: '', mailing_address: '' };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? '編輯廠商' : '新增廠商'}</h1>
                    <button data-view="vendorManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-4xl mx-auto">
                    <form id="vendor-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Column 1 -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">廠商代號*</label>
                                    <input type="text" name="vendor_id" value="${formData.vendor_id || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100" ${isEditing ? 'readonly' : 'required'}>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">廠商名稱*</label>
                                    <input type="text" name="name" value="${formData.name || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">廠商簡稱*</label>
                                    <input type="text" name="short_name" value="${formData.short_name || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">統一編號</label>
                                    <input type="text" name="tax_id" value="${formData.tax_id || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <p id="tax-id-error" class="text-xs text-red-500 mt-1 hidden">統一編號格式錯誤</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">聯絡人</label>
                                    <input type="text" name="contact_person" value="${formData.contact_person || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                            </div>
                            <!-- Column 2 -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">連絡電話</label>
                                    <input type="text" name="phone" value="${formData.phone || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">手機號碼</label>
                                    <input type="text" name="mobile_phone" value="${formData.mobile_phone || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">傳真</label>
                                    <input type="text" name="fax" value="${formData.fax || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">付款方式</label>
                                    <select name="payment_method" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option ${!formData.payment_method ? 'selected' : ''} disabled value="">請選擇</option>
                                        ${['電匯即期', '電匯30天', '電匯60天', '電匯90天', '每月20日', '現金'].map(o => `<option value="${o}" ${formData.payment_method === o ? 'selected' : ''}>${o}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">稅別</label>
                                    <select name="tax_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option ${!formData.tax_type ? 'selected' : ''} disabled value="">請選擇</option>
                                        ${['含稅', '未稅', '零稅', '免稅'].map(o => `<option value="${o}" ${formData.tax_type === o ? 'selected' : ''}>${o}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <!-- Column 3 -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">公司地址</label>
                                    <input type="text" name="address" value="${formData.address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">發票地址</label>
                                    <label class="flex items-center text-xs mt-1"><input type="checkbox" id="copy-invoice-address"> 同公司地址</label>
                                    <input type="text" name="invoice_address" value="${formData.invoice_address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">寄款地址</label>
                                    <label class="flex items-center text-xs mt-1"><input type="checkbox" id="copy-mailing-address"> 同公司地址</label>
                                    <input type="text" name="mailing_address" value="${formData.mailing_address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                            </div>
                            <!-- Full Width -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">備註</label>
                                <textarea name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${formData.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="button" data-action="save-vendor" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">儲存</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        // --- 模態框 ---
        const renderModal = (content) => {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-container').style.display = 'flex';
        };

        const closeModal = () => {
            document.getElementById('modal-container').style.display = 'none';
            document.getElementById('modal-content').innerHTML = '';
            state.local.consolidatedData = null;
        };

        // --- 事件處理器 ---
        
        document.body.addEventListener('click', (e) => {
            const notificationLink = e.target.closest('[data-action="view-notification-detail"]');
            if (notificationLink) {
                e.preventDefault();
                const requestId = notificationLink.dataset.id;
                const notificationId = notificationLink.dataset.notificationId;
                const request = state.requests.find(r => r.id == requestId);

                if (request) {
                    if (notificationId) {
                        const notification = state.applicantNotifications.find(n => n.id == notificationId);
                        if (notification && !notification.is_read) {
                            supabase.from('notifications').update({ is_read: true }).eq('id', notificationId).then(({error}) => {
                                if (error) console.error("更新通知狀態失敗:", error);
                            });
                        }
                    }
                    
                    const dropdown = document.getElementById('notification-dropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                    updateState({ view: 'detailView', selectedRequest: request });
                }
                return;
            }

            const viewSwitchBtn = e.target.closest('.view-switch-btn');
            if (viewSwitchBtn) {
                state.local.newRequestCart = [];
                 if (viewSwitchBtn.dataset.view === 'newRequest') {
                    updateState({ 
                        view: viewSwitchBtn.dataset.view
                    });
                } else {
                    updateState({ view: viewSwitchBtn.dataset.view });
                }
                return;
            }
            if (e.target.id === 'logout-btn') {
                supabase.auth.signOut();
                return;
            }
            if (e.target.id === 'change-password-btn') {
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">修改密碼</h3>
                    <p class="mb-4">為 ${state.currentUser.name} 設定新密碼：</p>
                    <label for="new-password" class="block text-sm font-medium text-gray-700">新密碼</label>
                    <input type="password" id="new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                        <button data-action="confirm-change-password" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white">確認修改</button>
                    </div>`);
                return;
            }

            const bell = e.target.closest('#notification-bell');
            const dropdown = document.getElementById('notification-dropdown');

            if (bell && dropdown) {
                dropdown.classList.toggle('hidden');
            } else if (!e.target.closest('.multi-select-container') && !e.target.closest('#notification-dropdown')) {
                 document.querySelectorAll('.multi-select-dropdown').forEach(el => el.classList.add('hidden'));
                 if(dropdown) dropdown.classList.add('hidden');
            }
        });

        document.getElementById('dashboard-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button, a, th');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'sort') {
                const key = button.dataset.sortKey;
                if (state.local.sortKey === key) {
                    state.local.sortDirection = state.local.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    state.local.sortKey = key;
                    state.local.sortDirection = 'asc';
                }
                renderDashboardTable();
            } else if (action === 'select-page') {
                e.preventDefault();
                const visibleIds = getFilteredRequests().slice((state.local.currentPage - 1) * state.local.itemsPerPage, state.local.currentPage * state.local.itemsPerPage).map(req => req.id);
                visibleIds.forEach(id => state.local.selectedRequestIds.add(id));
                renderDashboard();
            } else if (action === 'select-all-filtered') {
                e.preventDefault();
                const allFilteredIds = getFilteredRequests().map(req => req.id);
                allFilteredIds.forEach(id => state.local.selectedRequestIds.add(id));
                renderDashboard();
            } else if (action === 'deselect-all') {
                e.preventDefault();
                state.local.selectedRequestIds.clear();
                renderDashboard();
            } else if (action === 'view-detail') {
                const requestId = button.dataset.id;
                const request = state.requests.find(r => r.id == requestId);
                if (request.status === '待送出' && request.applicant_id === state.currentUser.id) {
                    // 編輯草稿
                    updateState({ 
                        view: 'newRequest', 
                        editingRequest: request, 
                        local: { ...state.local, newRequestCart: request.items || [] } 
                    });
                } else {
                    // 檢視或簽核
                    updateState({ selectedRequest: request, view: 'detailView' });
                }
            } else if (action === 'search-dashboard') {
                const searchTerm = document.getElementById('dashboard-search-input').value;
                state.local.selectedRequestIds.clear();
                state.local.currentPage = 1;
                state.local.dashboardFilters.searchTerm = searchTerm;
                renderDashboardTable();
            } else if (action === 'batch-approve' || action === 'batch-reject' || action === 'batch-close') {
                const selectedIds = Array.from(state.local.selectedRequestIds);
                let requestsToProcess = [];
                let modalTitle = '';
                let modalAction = '';

                if (action === 'batch-approve' || action === 'batch-reject') {
                    requestsToProcess = state.requests.filter(req => 
                        selectedIds.includes(req.id) &&
                        req.status === '待審核' &&
                        (req.approvers || []).find(a => a.status === 'pending')?.userId === state.currentUser.id
                    );
                } else if (action === 'batch-close') {
                    requestsToProcess = state.requests.filter(req => 
                        selectedIds.includes(req.id) &&
                        req.status === '已核准' &&
                        (req.closed_status === '未結案' || !req.closed_status)
                    );
                }

                if (requestsToProcess.length === 0) {
                    showMessage('沒有可供操作的已選取單據。', 'error');
                    return;
                }

                if (action === 'batch-approve') {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">批次核准</h3>
                        <p class="mb-4">您確定要核准 ${requestsToProcess.length} 筆申請單嗎？</p>
                        <label for="batch-approval-comment" class="block text-sm font-medium text-gray-700">簽核意見 (選填，將套用至所有單據)</label>
                        <textarea id="batch-approval-comment" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                            <button data-action="confirm-batch-approve" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white">確認核准</button>
                        </div>
                    `);
                } else if (action === 'batch-reject') {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">批次退回</h3>
                        <p class="mb-4">您確定要退回 ${requestsToProcess.length} 筆申請單嗎？</p>
                        <label for="batch-rejection-reason" class="block text-sm font-medium text-gray-700">退回理由 (必填，將套用至所有單据)</label>
                        <textarea id="batch-rejection-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                            <button data-action="confirm-batch-reject" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">確認退回</button>
                        </div>
                    `);
                } else if (action === 'batch-close') {
                     renderModal(`
                        <h3 class="text-lg font-bold mb-4">批次結案</h3>
                        <p class="mb-4">您確定要將 ${requestsToProcess.length} 筆已核准的申請單結案嗎？</p>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                            <button data-action="confirm-batch-close" data-ids='${JSON.stringify(requestsToProcess.map(r => r.id))}' class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-600 text-white">確認結案</button>
                        </div>
                    `);
                }
            } else if (action === 'consolidate-by-vendor') {
                let requestsToProcess;
                if (state.local.selectedRequestIds.size > 0) {
                    requestsToProcess = state.requests.filter(req => state.local.selectedRequestIds.has(req.id));
                } else {
                    requestsToProcess = getFilteredRequests();
                }

                if (requestsToProcess.length === 0) {
                    showMessage('沒有可彙整的訂單', 'error');
                    return;
                }

                renderModal(`
                    <h3 class="text-xl font-bold mb-4">選擇要彙整的訂單狀態</h3>
                    <p class="text-sm text-gray-600 mb-6">請勾選您希望納入廠商彙整的訂單簽核狀態。</p>
                    <div class="space-y-3 mb-8">
                        <label class="flex items-center"><input type="checkbox" value="待審核" class="consolidation-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">待審核</span></label>
                        <label class="flex items-center"><input type="checkbox" value="已核准" class="consolidation-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">已核准</span></label>
                        <label class="flex items-center"><input type="checkbox" value="已退回" class="consolidation-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">已退回</span></label>
                    </div>
                    <h4 class="text-md font-bold mb-2">篩選結案狀態</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="未結案" class="consolidation-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">未結案</span></label>
                        <label class="flex items-center"><input type="checkbox" value="結案" class="consolidation-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">結案</span></label>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-action="confirm-consolidation" class="px-4 py-2 rounded-md font-semibold text-sm bg-teal-600 text-white hover:bg-teal-700">確認彙整</button>
                    </div>
                `);
            } else if (action === 'export') {
                let dataToExport;
                if (state.local.selectedRequestIds.size > 0) {
                    dataToExport = state.requests.filter(req => state.local.selectedRequestIds.has(req.id));
                } else {
                    const filteredRequests = getFilteredRequests();
                    const { currentPage, itemsPerPage } = state.local;
                    const startIndex = (currentPage - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    dataToExport = filteredRequests.slice(startIndex, endIndex);
                }

                if(dataToExport.length === 0) { showMessage('沒有資料可匯出', 'error'); return; }
                
                const headers = ['申請單號', '申請日期', '申請人', '部門', '狀態', '品名', '規格', '單價', '單位', '數量', '小計', '簽核狀態'];
                const csvRows = [headers.join(',')];

                dataToExport.forEach(req => {
                    const commonData = [ req.id, getFormattedDateTime(req.request_date), state.users[req.applicant_id]?.name || req.applicant_id, req.department, req.status ];
                    const approval = (req.approvers || []).map(a => `${a.role}:${a.status}`).join('; ');

                    if (req.items && req.items.length > 0) {
                        req.items.forEach(item => {
                            const itemData = [ `"${item.name || ''}"`, `"${item.spec || ''}"`, item.price || 0, item.unit || '', item.quantity || 0, (item.price || 0) * (item.quantity || 0), `"${approval}"` ];
                            csvRows.push([...commonData, ...itemData].join(','));
                        });
                    } else {
                        const emptyItemData = ['', '', '', '', '', '', `"${approval}"`];
                        csvRows.push([...commonData, ...emptyItemData].join(','));
                    }
                });

                const csvString = "\uFEFF" + csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.setAttribute("href", URL.createObjectURL(blob));
                link.setAttribute("download", `訂單報表_${getISODateString(new Date())}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else if (action === 'delete-draft') {
                const requestId = button.dataset.id;
                const request = state.requests.find(r => r.id == requestId);
                if (request && request.status === '待送出') {
                    const canDelete = request.applicant_id === state.currentUser.id || state.currentUser.is_admin;
                    if (canDelete) {
                        renderModal(`
                            &lt;h3 class="text-lg font-bold mb-4"&gt;確認刪除草稿&lt;/h3&gt;
                            &lt;p class="mb-6"&gt;您確定要刪除申請單草稿 "${requestId}" 嗎？此操作無法復原。&lt;/p&gt;
                            &lt;div class="flex justify-end space-x-4"&gt;
                                &lt;button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300"&gt;取消&lt;/button&gt;
                                &lt;button data-id="${requestId}" data-action="confirm-delete-draft" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700"&gt;確認刪除&lt;/button&gt;
                            &lt;/div&gt;
                        `);
                    } else {
                        showMessage('您沒有權限刪除此草稿', 'error');
                    }
                }
            } else if (action === 'go-to-page') {
                state.local.currentPage = parseInt(button.dataset.page, 10);
                renderDashboardTable();
            } else if (action === 'refresh') {
                loadDashboardData();
            } else if (e.target.closest('.multi-select-toggle')) {
                const toggle = e.target.closest('.multi-select-toggle');
                e.preventDefault();
                
                document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                    if (d !== toggle.nextElementSibling) {
                        d.classList.add('hidden');
                    }
                });

                const dropdown = toggle.nextElementSibling;
                const filterKey = toggle.dataset.filterKey;

                if (dropdown.classList.contains('hidden')) {
                    tempSelections[filterKey] = new Set(state.local.dashboardFilters[filterKey]);
                    const checkboxes = dropdown.querySelectorAll('.multi-select-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = tempSelections[filterKey].has(cb.value);
                    });

                    // 確保臨時選擇狀態與實際篩選狀態同步
                    if (!tempSelections[filterKey]) {
                        tempSelections[filterKey] = new Set(state.local.dashboardFilters[filterKey]);
                    }
                }
                
                dropdown.classList.toggle('hidden');
            } else if (action === 'select-all-multi') {
                const filterKey = button.dataset.filterKey;
                const dropdown = button.closest('.multi-select-dropdown');
                const checkboxes = dropdown.querySelectorAll('.multi-select-checkbox');
                checkboxes.forEach(cb => {
                    if (cb.closest('li').style.display !== 'none') {
                        cb.checked = true;
                        tempSelections[filterKey].add(cb.value);
                    }
                });
            } else if (action === 'deselect-all-multi') {
                const filterKey = button.dataset.filterKey;
                const dropdown = button.closest('.multi-select-dropdown');
                const checkboxes = dropdown.querySelectorAll('.multi-select-checkbox');
                checkboxes.forEach(cb => {
                     if (cb.closest('li').style.display !== 'none') {
                        cb.checked = false;
                        tempSelections[filterKey].delete(cb.value);
                    }
                });
            } else if (action === 'cancel-multi-select') {
                button.closest('.multi-select-dropdown').classList.add('hidden');
            } else if (action === 'confirm-multi-select') {
                const filterKey = button.dataset.filterKey;
                state.local.dashboardFilters[filterKey] = new Set(tempSelections[filterKey]);
                button.closest('.multi-select-dropdown').classList.add('hidden');
                renderDashboardFilters();
                renderDashboardTable();
            }
        });

        document.getElementById('dashboard-view').addEventListener('change', (e) => {
            const target = e.target;
            if (target.matches('.filter-change')) {
                state.local.selectedRequestIds.clear();
                state.local.currentPage = 1;
                state.local.dashboardFilters[target.dataset.filter] = target.value;
                renderDashboard();
            } else if (target.matches('.request-checkbox')) {
                const id = target.dataset.id;
                if (target.checked) {
                    state.local.selectedRequestIds.add(id);
                } else {
                    state.local.selectedRequestIds.delete(id);
                }
                renderDashboard();
            } else if (target.matches('.multi-select-checkbox')) {
                const filterKey = target.dataset.filterKey;
                const value = target.value;
                if (target.checked) {
                    tempSelections[filterKey].add(value);
                } else {
                    tempSelections[filterKey].delete(value);
                }
            }
        });

        document.getElementById('dashboard-view').addEventListener('keyup', (e) => {
            if (e.target.matches('.multi-select-search')) {
                const searchTerm = e.target.value.toLowerCase();
                const listItems = e.target.nextElementSibling.querySelectorAll('li');
                listItems.forEach(li => {
                    const label = li.querySelector('span').textContent.toLowerCase();
                    const value = li.querySelector('input').value.toLowerCase();
                    if (label.includes(searchTerm) || value.includes(searchTerm)) {
                        li.style.display = '';
                    } else {
                        li.style.display = 'none';
                    }
                });
            }
        });

        document.getElementById('newRequest-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'switch-category') {
                state.local.activeProductCategory = button.dataset.category;
                state.local.newRequestSearchTerm = '';
                const searchInput = document.getElementById('new-request-product-search');
                if (searchInput) searchInput.value = '';
                
                document.querySelectorAll('#newRequest-view .product-category-btn').forEach(btn => {
                    btn.classList.toggle('border-blue-500', btn === button);
                    btn.classList.toggle('text-blue-600', btn === button);
                });
                renderProductList();
            } else if (action === 'add-to-cart') {
                const product = JSON.parse(button.dataset.product);
                const quantityInput = button.previousElementSibling;
                const quantity = parseInt(quantityInput.value, 10);
                if (quantity > 0) {
                    const existingItem = state.local.newRequestCart.find(item => item.id === product.id);
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        state.local.newRequestCart.push({ 
                            ...product, 
                            quantity, 
                            is_scrap_work_order: false, 
                            work_order_number: '',
                            demand_department: state.currentUser.department || '',
                            reason: '新增',
                            description: ''
                        });
                    }
                    quantityInput.value = 1;
                    renderNewRequestSidebar();
                } else {
                    showMessage('請輸入品項數量', 'error');
                }
            } else if (action === 'submit-request' || action === 'save-request') {
                const isSubmitting = action === 'submit-request';
                const { newRequestCart } = state.local;
                
                for (const item of newRequestCart) {
                    if (item.is_scrap_work_order && !item.work_order_number?.trim()) {
                        showMessage(`品項 "${item.name}" 已勾選報廢工單，但未填寫工單號碼。`, 'error');
                        return;
                    }
                }

                if (newRequestCart.length > 0) {
                    updateState({ loading: true });
                    try {
                        const totalAmount = newRequestCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                        const reason = document.getElementById('request-reason')?.value || '';
                        
                        const applicant = state.currentUser;
                        const allUsers = state.users;
                        const approvers = [];
                        
                        if (isSubmitting) {
                            let step = 1;
                            if (applicant && applicant.manager_id) {
                                const manager1 = Object.values(allUsers).find(u => u.id === applicant.manager_id);
                                if (manager1) approvers.push({ step: step++, role: '申請人主管', userId: manager1.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            if (applicant && applicant.manager_id2) {
                                const manager2 = Object.values(allUsers).find(u => u.id === applicant.manager_id2);
                                if (manager2) approvers.push({ step: step++, role: manager2.role, userId: manager2.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            const departmentThreshold = state.departments[applicant.department] || Infinity;
                            if (totalAmount > departmentThreshold) {
                                const director = Object.values(allUsers).find(u => u.role === '院長');
                                if (director) approvers.push({ step: step++, role: '院長', userId: director.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            const coreWorkflow = ['採購', '採購主管'];
                            let purchasingManager;
                            coreWorkflow.forEach(role => {
                                const approverUser = Object.values(allUsers).find(u => u.role === role);
                                if (approverUser) {
                                    approvers.push({ step: step++, role: role, userId: approverUser.id, status: 'pending', date: '', reason: '', comment: '' });
                                    if (role === '採購主管') purchasingManager = approverUser;
                                }
                            });
                            if (purchasingManager && purchasingManager.manager_id) {
                                const finalManager = Object.values(allUsers).find(u => u.id === purchasingManager.manager_id);
                                if (finalManager) approvers.push({ step: step++, role: finalManager.role, userId: finalManager.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                        }

                        const requestData = {
                            applicant_id: state.currentUser.id, 
                            applicant_name: state.currentUser.name,
                            department: state.currentUser.department,
                            items: newRequestCart, 
                            type: '特採', 
                            status: isSubmitting ? '待審核' : '待送出', 
                            total_amount: totalAmount,
                            reason: reason,
                            approvers: approvers
                        };

                        if (state.editingRequest) {
                            // 更新現有申請單（草稿或重新送出）
                            const { error } = await supabase.from('requests').update(requestData).eq('id', state.editingRequest.id);
                            if(error) throw error;

                            // 如果是送出申請且有簽核流程，發送通知給第一個簽核者
                            if (isSubmitting && approvers.length > 0) {
                                const firstApprover = approvers[0];
                                await supabase.from('notifications').insert({
                                    user_id: firstApprover.userId,
                                    request_id: state.editingRequest.id,
                                    message: `您有新的特採申請單 ${state.editingRequest.id} 待簽核，申請人：${state.currentUser.name}`,
                                    is_read: false
                                });
                            }
                        } else {
                            // 新增申請
                            const { data: newRequestId, error: rpcError } = await supabase.rpc('create_new_request_id');
                            if (rpcError) throw rpcError;
                            requestData.id = newRequestId;
                            const { error } = await supabase.from('requests').insert(requestData);
                            if(error) throw error;

                            // 如果是送出申請且有簽核流程，發送通知給第一個簽核者
                            if (isSubmitting && approvers.length > 0) {
                                const firstApprover = approvers[0];
                                await supabase.from('notifications').insert({
                                    user_id: firstApprover.userId,
                                    request_id: newRequestId,
                                    message: `您有新的特採申請單 ${newRequestId} 待簽核，申請人：${state.currentUser.name}`,
                                    is_read: false
                                });
                            }
                        }
                        
                        state.local.newRequestCart = [];
                        state.editingRequest = null;
                        showMessage(isSubmitting ? '申請單已成功送出！' : '草稿已儲存！');
                        await loadDashboardData(true); // 重新載入所有資料並導向儀表板

                    } catch (err) {
                        console.error("Error saving/submitting request:", err);
                        showMessage('操作失敗: ' + err.message, 'error');
                        updateState({ loading: false });
                    }
                }
            } else if (action === 'remove-from-cart') {
                const productId = button.dataset.id;
                state.local.newRequestCart = state.local.newRequestCart.filter(item => item.id != productId);
                renderNewRequestSidebar();
            } else if (action === 'search-new-request-product') {
                const searchTerm = document.getElementById('new-request-product-search').value;
                const searchAll = document.getElementById('new-request-search-all-checkbox').checked;
                updateState({ local: { ...state.local, newRequestSearchTerm: searchTerm, newRequestSearchAll: searchAll } });
            } else if (action === 'toggle-favorite') {
                const productId = parseInt(button.dataset.productId, 10);
                const favorites = state.local.favoriteProductIds;
                if (favorites.has(productId)) {
                    favorites.delete(productId);
                } else {
                    favorites.add(productId);
                }
                saveFavoritesToDb(state.currentUser.id, favorites);
                renderProductList(); 
            }
        });

        document.getElementById('newRequest-view').addEventListener('change', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const itemId = parseInt(target.dataset.id, 10);
            const itemInCart = state.local.newRequestCart.find(item => item.id == itemId);

            if (!itemInCart) return;

            if (action === 'update-cart-quantity') {
                const newQuantity = parseInt(target.value, 10);
                if (newQuantity > 0) {
                    itemInCart.quantity = newQuantity;
                } else {
                    state.local.newRequestCart = state.local.newRequestCart.filter(item => item.id != itemId);
                }
                renderNewRequestSidebar();
            } else if (action === 'toggle-item-scrap') {
                itemInCart.is_scrap_work_order = target.checked;
                if (!target.checked) {
                    itemInCart.work_order_number = '';
                }
                renderNewRequestSidebar();
            } else if (action === 'update-item-reason') {
                itemInCart.reason = target.value;
            }
        });
        
        document.getElementById('newRequest-view').addEventListener('input', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const itemId = parseInt(target.dataset.id, 10);
            const itemInCart = state.local.newRequestCart.find(item => item.id == itemId);

            if (itemInCart && action === 'update-item-work-order') {
                itemInCart.work_order_number = target.value;
            } else if (itemInCart && action === 'update-item-demand-dept') {
                itemInCart.demand_department = target.value;
            } else if (itemInCart && action === 'update-item-description') {
                itemInCart.description = target.value;
            }
        });

        document.getElementById('detailView-view').addEventListener('input', (e) => {
            if (e.target.classList.contains('item-input')) {
                const form = document.getElementById('edit-request-form');
                const formData = new FormData(form);
                let grandTotal = 0;
                state.selectedRequest.items.forEach((item, index) => {
                    const price = parseFloat(formData.get(`price_${index}`)) || 0;
                    const quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                    const subtotal = price * quantity;
                    grandTotal += subtotal;
                    const subtotalCell = document.querySelector(`.subtotal-cell[data-index="${index}"]`);
                    if (subtotalCell) subtotalCell.textContent = `$${subtotal.toLocaleString()}`;
                });
                const grandTotalCell = document.getElementById('grand-total');
                if (grandTotalCell) grandTotalCell.textContent = `$${grandTotal.toLocaleString()}`;
            }
        });

        document.getElementById('detailView-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'approve' || action === 'save-changes') {
                if (action === 'save-changes') {
                    const modificationReason = document.getElementById('modification-reason').value;
                    if (!modificationReason.trim()) {
                        showMessage('修改訂單內容時，必須填寫修改原因。', 'error');
                        return;
                    }
                }

                updateState({ loading: true });
                try {
                    const currentRequest = state.selectedRequest;
                    const approvers = [...currentRequest.approvers];
                    const currentStepIndex = approvers.findIndex(a => a.status === 'pending');

                    if (currentStepIndex !== -1) {
                        approvers[currentStepIndex].status = 'approved';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].comment = document.getElementById('approval-comment').value || '';
                        
                        const isFinal = currentStepIndex === approvers.length - 1;
                        const newStatus = isFinal ? '已核准' : '待審核';

                        let updateData = { approvers, status: newStatus };

                        if (action === 'save-changes') {
                            const modificationReason = document.getElementById('modification-reason').value;
                            const form = document.getElementById('edit-request-form');
                            const formData = new FormData(form);
                            const newItems = currentRequest.items.map((item, index) => ({
                                ...item,
                                name: formData.get(`name_${index}`),
                                price: parseFloat(formData.get(`price_${index}`)) || 0,
                                quantity: parseInt(formData.get(`quantity_${index}`), 10) || 0,
                                unit: formData.get(`unit_${index}`),
                            }));
                            const newTotalAmount = newItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
                            
                            const newHistoryEntry = {
                                user: state.currentUser.name,
                                role: state.currentUser.role,
                                date: new Date().toISOString(),
                                reason: modificationReason
                            };
                            
                            updateData.items = newItems;
                            updateData.total_amount = newTotalAmount;
                            updateData.modification_history = [...(currentRequest.modification_history || []), newHistoryEntry];
                        }
                        
                        let notificationMessage = `您的申請單 ${currentRequest.id} 已由 ${state.currentUser.name} 核准。`;
                        if (isFinal) {
                            notificationMessage = `您的申請單 ${currentRequest.id} 已全數簽核完成！`;
                        }
                        
                        await supabase.from('notifications').insert({
                            user_id: currentRequest.applicant_id,
                            request_id: currentRequest.id,
                            message: notificationMessage,
                            is_read: false
                        });

                        const { data: updatedRequest, error } = await supabase.from('requests').update(updateData).eq('id', currentRequest.id).select().single();
                        if (error) throw error;

                        const newRequests = state.requests.map(r => r.id === updatedRequest.id ? updatedRequest : r);
                        getFilteredRequests.resetCache();
                        
                        showMessage('申請單已核准');
                        updateState({ view: 'dashboard', loading: false, requests: newRequests });
                    }
                } catch (err) {
                    console.error("核准失敗:", err);
                    showMessage('核准失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'reject') {
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">退回申請</h3>
                    <label for="rejection-reason" class="block text-sm font-medium text-gray-700">退回理由：</label>
                    <textarea id="rejection-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                        <button data-action="confirm-reject-previous" class="px-4 py-2 rounded-md font-semibold text-sm bg-yellow-500 text-white">退回上一層</button>
                        <button data-action="confirm-reject-all" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">整筆退單</button>
                    </div>`);
            } else if (action === 'close-request') {
                updateState({ loading: true });
                try {
                    const { data, error } = await supabase.from('requests').update({ closed_status: '結案' }).eq('id', state.selectedRequest.id).select().single();
                    if (error) throw error;
                    
                    showMessage('申請單已結案');
                    updateState({ selectedRequest: data, loading: false });
                } catch (err) {
                    showMessage('結案失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            }
        });

        document.getElementById('productManagement-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button, th');
            if (!button) return;
            const action = button.dataset.action;
            const productId = button.dataset.id;

            if (action === 'sort-product') {
                const key = button.dataset.sortKey;
                if (state.local.productSortKey === key) {
                    state.local.productSortDirection = state.local.productSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    state.local.productSortKey = key;
                    state.local.productSortDirection = 'asc';
                }
                render();
            } else if (action === 'add-product') {
                state.editingProduct = null;
                updateState({ view: 'productForm' });
            } else if (action === 'edit-product') {
                const product = state.allProducts.find(p => p.id == productId);
                state.editingProduct = product;
                updateState({ view: 'productForm' });
            } else if (action === 'delete-product') {
                const productName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">確認刪除</h3>
                    <p class="mb-6">您確定要刪除商品 "${productName}" 嗎？此操作無法復原。</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-id="${productId}" data-action="confirm-delete-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">確認刪除</button>
                    </div>
                `);
            } else if (action === 'switch-product-category') {
                updateState({ local: { ...state.local, activeProductManagementCategory: button.dataset.category, productManagementSearchTerm: '' } });
            } else if (action === 'search-product') {
                const searchTerm = document.getElementById('product-search-input').value;
                const searchAll = document.getElementById('product-management-search-all-checkbox').checked;
                updateState({ local: { ...state.local, productManagementSearchTerm: searchTerm, productManagementSearchAll: searchAll } });
            }
        });

        document.getElementById('productManagement-view').addEventListener('change', (e) => {
            if (e.target.id === 'product-management-search-all-checkbox') {
                updateState({ local: { ...state.local, productManagementSearchAll: e.target.checked } });
            }
        });

        document.getElementById('productForm-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'save-product') {
                const form = document.getElementById('product-form');
                if (!form.reportValidity()) return;

                const formData = new FormData(form);
                const productData = Object.fromEntries(formData.entries());
                productData.price = parseFloat(productData.price) || 0;
                
                updateState({ loading: true });

                try {
                    const { data: savedProduct, error } = await supabase
                        .from('products')
                        .upsert(productData, { onConflict: 'id' })
                        .select()
                        .single();

                    if (error) {
                        if (error.code === '23505') { 
                            throw new Error(`商品編號 "${productData.id}" 已存在。`);
                        }
                        throw error;
                    }

                    const productIndex = state.allProducts.findIndex(p => p.id === savedProduct.id);
                    if (productIndex > -1) {
                        state.allProducts[productIndex] = savedProduct;
                    } else {
                        state.allProducts.push(savedProduct);
                    }

                    const productsData = {};
                    state.allProducts.forEach(product => {
                        const category = product.category;
                        if (!productsData[category]) productsData[category] = [];
                        productsData[category].push(product);
                    });
                    
                    showMessage('商品已儲存');
                    updateState({ view: 'productManagement', loading: false, products: productsData });

                } catch (err) {
                    showMessage('儲存失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'upload-image') {
                const fileInput = document.getElementById('image-upload-input');
                const file = fileInput.files[0];
                if (!file) {
                    showMessage('請先選擇一個圖片檔案。', 'error');
                    return;
                }

                const uploadButton = e.target;
                uploadButton.textContent = '上傳中...';
                uploadButton.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const { data, error } = await supabase.functions.invoke('upload-product-image', {
                        body: formData,
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    const imageId = data.fileId;
                    
                    const hiddenImageInput = document.querySelector('#product-form input[name="image"]');
                    hiddenImageInput.value = imageId;

                    const preview = document.getElementById('product-form-image-preview');
                    preview.src = `https://drive.google.com/thumbnail?id=${imageId}`;
                    
                    showMessage('圖片上傳成功！請記得點擊「儲存」以完成更新。');
                    uploadButton.textContent = '上傳完成';

                } catch (err) {
                    console.error("圖片上傳失敗:", err);
                    showMessage(`圖片上傳失敗: ${err.message}`, 'error');
                    uploadButton.textContent = '上傳圖片';
                    uploadButton.disabled = false;
                }
            }
        });
        
        document.getElementById('productForm-view').addEventListener('change', (e) => {
            const target = e.target;
            if (target.id === 'image-upload-input') {
                const file = target.files[0];
                const filenameSpan = document.getElementById('image-upload-filename');
                const uploadButton = document.getElementById('image-upload-button');
                if (file) {
                    filenameSpan.textContent = file.name;
                    uploadButton.disabled = false;
                    uploadButton.textContent = '上傳圖片';
                } else {
                    filenameSpan.textContent = '尚未選擇檔案';
                    uploadButton.disabled = true;
                }
            }
        });

        document.getElementById('personalForms-view').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            const link = e.target.closest('a');

            if (link) {
                const action = link.dataset.action;
                const requestId = link.dataset.id;

                if (action === 'view-detail' && requestId) {
                    e.preventDefault();
                    const request = state.requests.find(r => r.id == requestId);
                    if (request) {
                        if (request.status === '待送出' && request.applicant_id === state.currentUser.id) {
                            // 編輯草稿
                            updateState({ 
                                view: 'newRequest', 
                                editingRequest: request, 
                                local: { ...state.local, newRequestCart: request.items || [] } 
                            });
                        } else {
                            // 檢視或簽核
                            updateState({ selectedRequest: request, view: 'detailView' });
                        }
                    }
                    return;
                }
            }

            if (!button) return;

            const tab = button.dataset.tab;
            if(tab) {
                updateState({ local: { ...state.local, personalForms: { ...state.local.personalForms, activeTab: tab } } });
            }
        });
        
        document.getElementById('personalForms-view').addEventListener('input', (e) => {
            const target = e.target;
            if (target.matches('.personal-forms-filter')) {
                clearTimeout(window.personalFormsSearchTimeout);
                window.personalFormsSearchTimeout = setTimeout(() => {
                    const filterType = target.dataset.filterType;
                    const activeTab = state.local.personalForms.activeTab;
                    
                    const updatedFilters = {
                        ...state.local.personalForms,
                        [activeTab]: {
                            ...state.local.personalForms[activeTab],
                            [filterType]: target.value
                        }
                    };
                    updateState({ local: { ...state.local, personalForms: updatedFilters } });
                }, 300);
            }
        });

        document.getElementById('userManagement-view').addEventListener('change', (e) => {
            if (e.target.id === 'user-dept-filter') {
                updateState({ local: { ...state.local, userManagementFilters: { ...state.local.userManagementFilters, department: e.target.value } } });
            }
        });

        document.getElementById('userManagement-view').addEventListener('keyup', (e) => {
            if (e.target.id === 'user-search-input') {
                clearTimeout(window.userSearchTimeout);
                window.userSearchTimeout = setTimeout(() => {
                    updateState({ local: { ...state.local, userManagementFilters: { ...state.local.userManagementFilters, searchTerm: e.target.value } } });
                }, 300);
            }
        });

        document.getElementById('userManagement-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const userId = button.dataset.id;

            if (action === 'add-user') {
                updateState({ editingUser: null, view: 'userForm' });
            } else if (action === 'edit-user') {
                const user = state.users[userId];
                updateState({ editingUser: user, view: 'userForm' });
            } else if (action === 'delete-user') {
                const userName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">確認刪除使用者</h3>
                    <p class="mb-6">您確定要刪除使用者 "${userName}" 嗎？此操作將會從系統中永久移除該使用者及其認證資料，且無法復原。</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-id="${userId}" data-action="confirm-delete-user" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">確認刪除</button>
                    </div>
                `);
            } else if (action === 'toggle-user-enabled') {
                const currentStatus = button.dataset.enabled === 'true';
                const newStatus = !currentStatus;
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .update({ is_enabled: newStatus })
                        .eq('id', userId)
                        .select()
                        .single();
                    if (error) throw error;
                    state.users[userId] = data;
                    showMessage(`使用者狀態已更新為 ${newStatus ? '啟用' : '停用'}`);
                    render();
                } catch (err) {
                    showMessage(`更新使用者狀態失敗: ${err.message}`, 'error');
                }
            }
        });

        document.getElementById('userForm-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || button.dataset.action !== 'save-user') return;

            const form = document.getElementById('user-form');
            if (!form.reportValidity()) return;

            const formData = new FormData(form);
            const isEditing = !!state.editingUser;

            const userData = {
                ...Object.fromEntries(formData.entries()),
                is_admin: form.elements.is_admin.checked,
                is_department_head: form.elements.is_department_head.checked,
                is_enabled: form.elements.is_enabled.checked,
            };
            
            if (userData.manager_id === '') userData.manager_id = null;
            if (userData.manager_id2 === '') userData.manager_id2 = null;
            if (userData.department === '') userData.department = null;

            updateState({ loading: true });

            try {
                if (isEditing) {
                    const userId = state.editingUser.id;
                    const { data, error } = await supabase.functions.invoke('update-user-admin', {
                        body: { user_id: userId, userData: userData }
                    });
                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    state.users[userId] = data.user;
                    showMessage('使用者資料更新成功！');
                    updateState({ view: 'userManagement', loading: false, users: { ...state.users } });

                } else {
                    const { password, ...profileData } = userData;
                    const { data, error: functionError } = await supabase.functions.invoke('create-user', {
                        body: {
                            email: userData.email,
                            password: password,
                            profileData: profileData
                        }
                    });

                    if (functionError) throw functionError;
                    if (data && data.error) throw new Error(data.error);
                    if (!data || !data.user) throw new Error('Edge Function 回傳了無效的資料格式。');

                    const newUserProfile = data.user;
                    state.users[newUserProfile.id] = newUserProfile;
                    showMessage('使用者新增成功！');
                    updateState({ view: 'userManagement', loading: false, users: { ...state.users } });
                }
            } catch (err) {
                console.error("儲存使用者失敗:", err);
                let detailedErrorMessage;

                if (isEditing) {
                    detailedErrorMessage = `更新使用者資料失敗。\n(原始錯誤: ${err.message})`;
                    detailedErrorMessage += "\n\n請檢查後端 'update-user-admin' 函數的日誌。";
                } else {
                    detailedErrorMessage = `後端函數 'create-user' 執行失敗。\n(原始錯誤: ${err.message})`;
                    detailedErrorMessage += "\n\n請檢查您 Supabase 專案中該函數的日誌(Logs)以尋找根本原因。";
                }

                showMessage(detailedErrorMessage, 'error');
                updateState({ loading: false });
            }
        });

        document.getElementById('vendorManagement-view').addEventListener('keyup', (e) => {
            if (e.target.id === 'vendor-search-input') {
                clearTimeout(window.vendorSearchTimeout);
                window.vendorSearchTimeout = setTimeout(() => {
                    updateState({ local: { ...state.local, vendorManagementSearchTerm: e.target.value } });
                }, 300);
            }
        });

        document.getElementById('vendorManagement-view').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const vendorId = button.dataset.id;

            if (action === 'add-vendor') {
                updateState({ editingVendor: null, view: 'vendorForm' });
            } else if (action === 'edit-vendor') {
                const vendor = state.vendors.find(v => v.vendor_id === vendorId);
                updateState({ editingVendor: vendor, view: 'vendorForm' });
            } else if (action === 'delete-vendor') {
                const vendorName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">確認刪除廠商</h3>
                    <p class="mb-6">您確定要刪除廠商 "${vendorName}" 嗎？此操作無法復原。</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-id="${vendorId}" data-action="confirm-delete-vendor" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">確認刪除</button>
                    </div>
                `);
            }
        });

        document.getElementById('vendorForm-view').addEventListener('change', (e) => {
            const target = e.target;
            const form = document.getElementById('vendor-form');
            if (!form) return;

            if (target.id === 'copy-invoice-address') {
                form.elements.invoice_address.value = target.checked ? form.elements.address.value : '';
            } else if (target.id === 'copy-mailing-address') {
                form.elements.mailing_address.value = target.checked ? form.elements.address.value : '';
            }
        });

        document.getElementById('vendorForm-view').addEventListener('input', (e) => {
            const target = e.target;
            if (target.name === 'tax_id') {
                const errorEl = document.getElementById('tax-id-error');
                if (target.value && !validateTaxId(target.value)) {
                    errorEl.classList.remove('hidden');
                } else {
                    errorEl.classList.add('hidden');
                }
            }
        });

        document.getElementById('vendorForm-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || button.dataset.action !== 'save-vendor') return;

            const form = document.getElementById('vendor-form');
            if (!form.reportValidity()) return;

            const taxId = form.elements.tax_id.value;
            if (taxId && !validateTaxId(taxId)) {
                showMessage('統一編號格式錯誤，請檢查後再儲存。', 'error');
                return;
            }

            const formData = new FormData(form);
            const vendorData = Object.fromEntries(formData.entries());
            
            updateState({ loading: true });

            try {
                const { data, error } = await supabase.from('vendors').upsert(vendorData, { onConflict: 'vendor_id' }).select().single();
                if (error) {
                    if (error.code === '23505') throw new Error(`廠商代號 "${vendorData.vendor_id}" 已存在。`);
                    throw error;
                }

                const index = state.vendors.findIndex(v => v.vendor_id === data.vendor_id);
                if (index > -1) {
                    state.vendors[index] = data;
                } else {
                    state.vendors.push(data);
                    state.vendors.sort((a, b) => a.vendor_id.localeCompare(b.vendor_id));
                }

                showMessage('廠商資料已儲存');
                updateState({ view: 'vendorManagement', loading: false, vendors: [...state.vendors] });
            } catch (err) {
                showMessage('儲存廠商失敗: ' + err.message, 'error');
                updateState({ loading: false });
            }
        });


        document.getElementById('modal-container').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            
            if(action === 'cancel-modal') {
                closeModal();
            } else if (action === 'confirm-delete-vendor') {
                const vendorId = button.dataset.id;
                try {
                    const { error } = await supabase.from('vendors').delete().eq('vendor_id', vendorId);
                    if (error) throw error;
                    
                    const newVendors = state.vendors.filter(v => v.vendor_id !== vendorId);
                    showMessage('廠商已成功刪除');
                    closeModal();
                    updateState({ vendors: newVendors, view: 'vendorManagement' });
                } catch (err) {
                    console.error("刪除廠商失敗:", err);
                    showMessage('刪除廠商失敗: ' + err.message, 'error');
                    closeModal();
                }
            } else if (action === 'confirm-delete-product') {
                const productId = button.dataset.id;
                if (productId) {
                    try {
                        const { error } = await supabase.from('products').delete().eq('id', productId);
                        if(error) throw error;
                        
                        const newAllProducts = state.allProducts.filter(p => p.id != productId);
                        
                        const newProductsData = {};
                        newAllProducts.forEach(product => {
                            const category = product.category;
                            if (!newProductsData[category]) newProductsData[category] = [];
                            newProductsData[category].push(product);
                        });
                        
                        showMessage('商品已成功刪除');
                        closeModal();
                        
                        updateState({ allProducts: newAllProducts, products: newProductsData });

                    } catch (err) {
                        console.error("刪除商品失敗:", err);
                        showMessage('刪除失敗: ' + err.message, 'error');
                        closeModal();
                    }
                }
            } else if (action === 'confirm-delete-user') {
                const userId = button.dataset.id;
                if (userId === state.currentUser.id) {
                    showMessage('無法刪除您自己。', 'error');
                    return;
                }

                try {
                    const { data, error } = await supabase.functions.invoke('delete-user-admin', {
                        body: { user_id: userId }
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    delete state.users[userId];
                    showMessage('使用者已成功刪除');
                    closeModal();
                    updateState({ users: { ...state.users } });

                } catch (err) {
                    console.error("刪除使用者失敗:", err);
                    showMessage('刪除使用者失敗: ' + err.message, 'error');
                    closeModal();
                }
            } else if (action === 'confirm-consolidation') {
                const selectedStatuses = [...document.querySelectorAll('.consolidation-status-checkbox:checked')].map(cb => cb.value);
                const selectedClosedStatuses = [...document.querySelectorAll('.consolidation-closed-checkbox:checked')].map(cb => cb.value);
                if (selectedStatuses.length === 0 || selectedClosedStatuses.length === 0) {
                    showMessage('請至少選擇一種訂單狀態和一種結案狀態', 'error');
                    return;
                }

                let requestsToProcess;
                if (state.local.selectedRequestIds.size > 0) {
                    requestsToProcess = state.requests.filter(req => state.local.selectedRequestIds.has(req.id));
                } else {
                    requestsToProcess = getFilteredRequests();
                }

                const filteredByStatus = requestsToProcess.filter(req => 
                    selectedStatuses.includes(req.status) &&
                    selectedClosedStatuses.includes(req.closed_status || '未結案')
                );

                if (filteredByStatus.length === 0) {
                    showMessage('沒有符合選取狀態的訂單可彙整', 'error');
                    closeModal();
                    return;
                }

                const consolidated = {};
                filteredByStatus.forEach(req => {
                    (req.items || []).forEach(item => {
                        const vendorId = item.vendor || '未指定廠商';
                        const vendorInfo = state.vendors.find(v => v.vendor_id === vendorId);
                        const vendorKey = vendorInfo ? (vendorInfo.short_name || vendorInfo.name) : vendorId;

                        if (!consolidated[vendorKey]) {
                            consolidated[vendorKey] = { items: {}, total: 0 };
                        }
                        const itemKey = item.id || item.name;
                        if (!consolidated[vendorKey].items[itemKey]) {
                            consolidated[vendorKey].items[itemKey] = { ...item, quantity: 0, subtotal: 0 };
                        }
                        consolidated[vendorKey].items[itemKey].quantity += item.quantity;
                        consolidated[vendorKey].items[itemKey].subtotal += item.quantity * item.price;
                        consolidated[vendorKey].total += item.quantity * item.price;
                    });
                });
                
                state.local.consolidatedData = consolidated;

                let modalHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">廠商彙總採購單</h2>
                        <div>
                            <button data-action="export-consolidation-xlsx" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">匯出 XLSX</button>
                            <button data-action="cancel-modal" class="ml-2 px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">關閉</button>
                        </div>
                    </div>
                `;

                Object.entries(consolidated).forEach(([vendor, data]) => {
                    modalHTML += `
                        <div class="mb-6 border rounded-lg p-4">
                            <h3 class="text-lg font-bold mb-2 bg-gray-100 p-2 rounded">${vendor} - 總金額: $${data.total.toLocaleString()}</h3>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left">品名</th>
                                        <th class="px-4 py-2 text-left">規格</th>
                                        <th class="px-4 py-2 text-right">單價</th>
                                        <th class="px-4 py-2 text-right">總數量</th>
                                        <th class="px-4 py-2 text-right">小計</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${Object.values(data.items).map(item => `
                                        <tr>
                                            <td class="px-4 py-2">${item.name}</td>
                                            <td class="px-4 py-2">${item.spec || ''}</td>
                                            <td class="px-4 py-2 text-right">$${item.price.toLocaleString()}</td>
                                            <td class="px-4 py-2 text-right">${item.quantity} ${item.unit}</td>
                                            <td class="px-4 py-2 text-right">$${item.subtotal.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                renderModal(modalHTML);

            } else if (action === 'export-consolidation-xlsx') {
                if (!state.local.consolidatedData) {
                    showMessage('沒有可匯出的彙整資料', 'error');
                    return;
                }
                try {
                    const workbook = await XlsxPopulate.fromBlankAsync();
                    Object.entries(state.local.consolidatedData).forEach(([vendor, data]) => {
                        const sheet = workbook.addSheet(vendor.replace(/[\/\\?*\[\]]/g, '')); // Remove invalid chars
                        sheet.cell("A1").value("品名");
                        sheet.cell("B1").value("規格");
                        sheet.cell("C1").value("單價");
                        sheet.cell("D1").value("總數量");
                        sheet.cell("E1").value("單位");
                        sheet.cell("F1").value("小計");
                        sheet.row(1).style("bold", true);

                        Object.values(data.items).forEach((item, index) => {
                            const row = index + 2;
                            sheet.cell(`A${row}`).value(item.name);
                            sheet.cell(`B${row}`).value(item.spec);
                            sheet.cell(`C${row}`).value(item.price).style("numberFormat", "$#,##0.00");
                            sheet.cell(`D${row}`).value(item.quantity);
                            sheet.cell(`E${row}`).value(item.unit);
                            sheet.cell(`F${row}`).value(item.subtotal).style("numberFormat", "$#,##0.00");
                        });
                        const totalRow = Object.values(data.items).length + 3;
                        sheet.cell(`E${totalRow}`).value("總金額").style("bold", true);
                        sheet.cell(`F${totalRow}`).value(data.total).style("bold", true).style("numberFormat", "$#,##0.00");
                    });
                    
                    workbook.deleteSheet("Sheet1"); // Delete default sheet
                    const blob = await workbook.outputAsync();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    document.body.appendChild(a);
                    a.style = "display: none";
                    a.href = url;
                    a.download = `廠商彙總訂單_${getISODateString(new Date())}.xlsx`;
                    a.click();
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                } catch (err) {
                    console.error("匯出 Excel 失敗:", err);
                    showMessage("匯出 Excel 失敗: " + err.message, 'error');
                }
            } else if (action === 'confirm-batch-close') {
                const idsToClose = JSON.parse(button.dataset.ids);
                updateState({ loading: true });
                try {
                    const { error } = await supabase.from('requests').update({ closed_status: '結案' }).in('id', idsToClose);
                    if (error) throw error;
                    
                    showMessage(`${idsToClose.length} 筆訂單已成功結案。`);
                    closeModal();
                    await loadDashboardData();
                    state.local.selectedRequestIds.clear();
                    renderDashboard();
                } catch (err) {
                    showMessage('批次結案失敗: ' + err.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            }
        });
        
        document.body.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (e.target.id === 'login-form') {
                const account = e.target.elements.account.value;
                const password = e.target.elements.password.value;
                let email = account;

                updateState({ loading: true, error: null }); 

                try {
                    if (!account.includes('@')) {
                        const { data, error } = await supabase.functions.invoke('find-email-by-id', {
                            body: { id: account }
                        });

                        if (error) throw error;
                        if (data.error) throw new Error(data.error);

                        if (data.emails.length === 0) {
                            throw new Error('Invalid login credentials');
                        } else if (data.emails.length > 1) {
                            throw new Error(`帳號 "${account}" 存在於多個網域，請輸入完整的 Email 登入。`);
                        }
                        email = data.emails[0];
                    }

                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;

                } catch (error) {
                    let message = "登入失敗，請檢查您的帳號和密碼。";
                    if (error.message.includes('Invalid login credentials')) {
                        message = "帳號或密碼錯誤。";
                    } else if (error.message.includes('User account is disabled')) {
                        message = "此帳號已被停用，請聯繫管理員。";
                    } else {
                        message = error.message;
                    }
                    showMessage(message, 'error');
                    updateState({ loading: false });
                }
            } 
        });

        // --- 初始載入與驗證狀態監聽 ---
        
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                if (state.currentUser && state.currentUser.id === session.user.id) {
                    return; 
                }

                updateState({ loading: true });
                const user = session.user;
                const { data: userProfile, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error || !userProfile) {
                    console.error("找不到使用者設定檔:", error);
                    await supabase.auth.signOut();
                    updateState({ error: "認證成功，但在資料庫中找不到您的設定檔。請聯繫管理員。", loading: false });
                } else {
                    state.currentUser = userProfile;
                    state.local.dashboardFilters.permission = 'pending_for_me'; 
                    if (userProfile.favorite_products && Array.isArray(userProfile.favorite_products)) {
                        state.local.favoriteProductIds = new Set(userProfile.favorite_products);
                    } else {
                        state.local.favoriteProductIds = new Set();
                    }
                    await loadDashboardData(true);
                }
            } 
            else {
                channels.forEach(channel => supabase.removeChannel(channel));
                channels = [];
                Object.assign(state, {
                    requests: [], products: {}, users: {}, categories: [], applicantNotifications: [],
                    currentUser: null,
                    loading: false, 
                    error: null
                });
                updateState({ view: 'login' });
            }
        });
        

        // --- Get Filtered Products ---
        const getFilteredProducts = () => {
            const { allProducts, products } = state;
            const { activeProductManagementCategory, productManagementSearchTerm, productManagementSearchAll, productSortKey, productSortDirection } = state.local;
            
            let productsToFilter = [];
            if (productManagementSearchAll || activeProductManagementCategory === '全品項' || !activeProductManagementCategory) {
                productsToFilter = allProducts;
            } else {
                productsToFilter = products[activeProductManagementCategory] || [];
            }

            const lowerCaseSearchTerm = (productManagementSearchTerm || '').toLowerCase();
            let filtered = productsToFilter;
            if (lowerCaseSearchTerm) {
                filtered = filtered.filter(p => {
                    const { image, ...searchableProduct } = p;
                    return JSON.stringify(searchableProduct).toLowerCase().includes(lowerCaseSearchTerm);
                });
            }
            
            if (productSortKey) {
                filtered.sort((a, b) => {
                    let valA = a[productSortKey];
                    let valB = b[productSortKey];

                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();

                    if (valA < valB) return productSortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return productSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            return filtered;
        };
    </script>
</body>
</html>
